<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hluck.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="报文、协议、Mac地址1.报文段  报文段是指TCP&#x2F;IP协议网络传输中，起着路由导航作用 用以查询各个网络路由网段、IP地址、交换协议等IP数据包 报文段充当整个TCP&#x2F;IP协议数据包的导航路由功能 报文段在传输过程中会不断的封装成组、包、帧来传输 封装方式就是添加一些控制信息组成的首部，即报文头  2.传输协议  一种规定，约束 简单来说：A &gt; B的传输数据，B能识别，反之B &gt;">
<meta property="og:type" content="article">
<meta property="og:title" content="UDP与TCP入门">
<meta property="og:url" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="余一">
<meta property="og:description" content="报文、协议、Mac地址1.报文段  报文段是指TCP&#x2F;IP协议网络传输中，起着路由导航作用 用以查询各个网络路由网段、IP地址、交换协议等IP数据包 报文段充当整个TCP&#x2F;IP协议数据包的导航路由功能 报文段在传输过程中会不断的封装成组、包、帧来传输 封装方式就是添加一些控制信息组成的首部，即报文头  2.传输协议  一种规定，约束 简单来说：A &gt; B的传输数据，B能识别，反之B &gt;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/1.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/2.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/3.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/4.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/5.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/6.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/7.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/8.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/9.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/10.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/11.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/12.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/13.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/14.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/15.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/16.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/17.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/18.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/19.png">
<meta property="og:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/20.png">
<meta property="article:published_time" content="2022-08-02T06:03:25.239Z">
<meta property="article:modified_time" content="2022-08-14T08:30:24.533Z">
<meta property="article:author" content="余一">
<meta property="article:tag" content="网络编程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/1.png">

<link rel="canonical" href="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>UDP与TCP入门 | 余一</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="余一" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">余一</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">纸上得来终觉浅，绝知此事要躬行。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hluck.github.io/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar5.jpg">
      <meta itemprop="name" content="余一">
      <meta itemprop="description" content="纸上得来终觉浅，绝知此事要躬行。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="余一">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UDP与TCP入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-02 14:03:25" itemprop="dateCreated datePublished" datetime="2022-08-02T14:03:25+08:00">2022-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-14 16:30:24" itemprop="dateModified" datetime="2022-08-14T16:30:24+08:00">2022-08-14</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>17 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="报文、协议、Mac地址"><a href="#报文、协议、Mac地址" class="headerlink" title="报文、协议、Mac地址"></a>报文、协议、Mac地址</h2><p><strong>1.报文段</strong></p>
<ul>
<li>报文段是指TCP/IP协议网络传输中，起着路由导航作用</li>
<li>用以查询各个网络路由网段、IP地址、交换协议等IP数据包</li>
<li>报文段充当整个TCP/IP协议数据包的导航路由功能</li>
<li>报文段在传输过程中会不断的封装成组、包、帧来传输</li>
<li>封装方式就是添加一些控制信息组成的首部，即报文头</li>
</ul>
<p><strong>2.传输协议</strong></p>
<ul>
<li>一种规定，约束</li>
<li>简单来说：A &gt; B的传输数据，B能识别，反之B &gt; A的传输数据A也能识别。这就是协议</li>
</ul>
<p><strong>3.Mac地址</strong></p>
<ul>
<li>Media Access Control或者Medium Access Control</li>
<li>译为媒体访问控制，或称物理地址、硬件地址</li>
<li><strong>用来定义网络设备的位置</strong></li>
<li>形如：44-45-53-54-00-00 与身份证类似 <a id="more"></a>
<h2 id="IP、端口以及远程服务器"><a href="#IP、端口以及远程服务器" class="headerlink" title="IP、端口以及远程服务器"></a>IP、端口以及远程服务器</h2></li>
</ul>
<ol>
<li><p><strong>IP地址</strong></p>
<ul>
<li><p>互联网协议地址(Internet Protocol Address)</p>
</li>
<li><p>是 分配给网络上使用网际协议（Internet Protocol  ,IP)的设备数字 标签</p>
</li>
<li><p>常见IP地址分为<strong>IPV4</strong> 与 <strong>IPV6</strong></p>
</li>
<li><p>IP地址由32位二进制数组成，常以xxx.xxx.xxx.xxx形式表现，每组xxx代表小于或等于255的10进制数</p>
<p><strong>IPV4:</strong></p>
<ul>
<li>如：208.80.152.2</li>
<li>分为A、B、C、D、E五大类，其中E类属于特殊保留地址</li>
<li>总数量：42亿个，最终于2011年2月2日用尽</li>
<li>如果主机号全是1，那么这个地址为直接广播地址</li>
<li>IP地址”255.255.255.255”为受限广播地址</li>
</ul>
<p><strong>IPV6:</strong></p>
<ul>
<li>总共有128位长，IPV6地址的表达形式，一般采用32个十六位进制数。也可以想象为1632个</li>
<li>由两个逻辑部分组成:一个64位的网络前缀和一个64位的主机地址，主机地址通常根据物理地址自动生成，叫做EUI-64(或者64位扩展唯一标识)</li>
<li>2001：0db8:85a3:0000:1319:8a2e:0370:7344</li>
<li>IPV4转换为IPV6一定可行，IPV6转换为IPV4不一定可行</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>端口</strong></p>
<ul>
<li>如果把IP地址比作一间房子，端口就是出入这间房子的门或窗户</li>
<li>不同门窗户后有不同的人（代表着不同程序的进程），房子中的用户与外界交流的出口</li>
<li>外界鸽子（信息）飞到不同窗户也就是给不同的人（程序进程）传递信息</li>
<li>从0到1023号端口以及1024到49151号端口都是特殊端口</li>
<li>计算机之间依照互联网传输层TCP/IP协议的协议通信，不同协议对应不同端口</li>
<li>49152到65535号端口属于”动态端口”范围，没有端口可以被正式的注册占用</li>
</ul>
</li>
</ol>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/1.png" alt></p>
<p><strong>数据传输层次：</strong></p>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/2.png" alt></p>
<p>3.<strong>远程服务器：</strong></p>
<ul>
<li>局域网：一般而言，家里的环境以及公司相互电脑之间环境都属于局域网</li>
<li>我与你们之间的电脑属于互联网，而非局域网</li>
<li>默认的：我的电脑无法直接链接到你们的电脑：不在同一局域网，可通过远程服务器通信</li>
</ul>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/3.png" alt></p>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/4.png" alt></p>
<h2 id="Socket-UDP"><a href="#Socket-UDP" class="headerlink" title="Socket UDP"></a>Socket UDP</h2><h3 id="UDP是什么"><a href="#UDP是什么" class="headerlink" title="UDP是什么"></a>UDP是什么</h3><ul>
<li>User Datagram Protocol</li>
<li><strong>用户数据报协议，又称用户数据报文协议</strong></li>
<li>是一个简单的面向<strong>数据报</strong>的<strong>传输层</strong>协议，正式规范为RFC 768</li>
<li>用户数据协议，非连接协议</li>
</ul>
<h5 id="为什么不可靠"><a href="#为什么不可靠" class="headerlink" title="为什么不可靠"></a>为什么不可靠</h5><ol>
<li>一旦把应用程序发给网络层的数据发送出去，就不保留数据备份</li>
<li>UDP在IP数据报的头部仅仅加入了复用和数据校验（字段）</li>
<li>发送端产生数据，接收端从网络中抓取数据</li>
<li>结构简单，无校验，速度快，容易丢包，可广播</li>
</ol>
<h5 id="UDP能做什么"><a href="#UDP能做什么" class="headerlink" title="UDP能做什么"></a>UDP能做什么</h5><ul>
<li>DNS,TFTP,SNMP</li>
<li>视频，音频，普通数据（无关紧要数据）</li>
</ul>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/5.png" alt></p>
<h5 id="UDP包最大长度"><a href="#UDP包最大长度" class="headerlink" title="UDP包最大长度"></a>UDP包最大长度</h5><ul>
<li>16位 -&gt; 2字节 存储长度信息</li>
<li>2^16 -1 = 64k -1 = 65536 -1 = 65535</li>
<li>自身协议占用：32 + 32位 = 64位 = 8字节，而在IP层进行封装后的IP包头占去20字节。</li>
<li><strong>65535 - 8 - 20 = 65507 byte</strong></li>
</ul>
<h4 id="UDP核心API"><a href="#UDP核心API" class="headerlink" title="UDP核心API"></a>UDP核心API</h4><h5 id="API-DatagramSocket"><a href="#API-DatagramSocket" class="headerlink" title="API-DatagramSocket"></a>API-DatagramSocket</h5><ul>
<li>用于接收与发送UDP的类</li>
<li>负责发送某一个UDP包,或者接收UDP包</li>
<li>不同于TCP，UDP并没有合并到Socket API中</li>
<li>DatagramSocket()创建简单实例，不指定端口与IP</li>
<li>DatagramSocket(int port)创建监听某端口的实例</li>
<li>DatagramSocket(int port,InetAddress localAddr)创建固定端口指定IP的实例</li>
<li>receive(DatagramPacket d) : 接收</li>
<li>send（DatagramPacket d) :发送</li>
<li>setSoTimeout(int timeout):设置超时，毫秒</li>
<li>close()关闭，释放资源</li>
</ul>
<h5 id="API-DatagramPacket"><a href="#API-DatagramPacket" class="headerlink" title="API-DatagramPacket"></a>API-DatagramPacket</h5><ul>
<li>用于处理报文</li>
<li>将byte数组、目标地址、目标端口等数据包封装成报文或者将报文拆卸成byte数组</li>
<li>是UDP的发送实体，也是UDP的接收实体</li>
<li>DatagramPacket(byte[] buf,int offset,int length,InetAddress address,int port):</li>
<li>前面3个参数指定buff的使用区间</li>
<li>后面2个参数指定目标机器地址，与端口（<strong>发送端地址，端口</strong>）</li>
<li>DatagramPacket(byte[] buf,int length,SocketAddress address)</li>
<li>前面2个参数指定buff的使用区间</li>
<li>SocketAddress 相当于InetAddress + port</li>
<li>setData(byte[] buf,int offset,int length)</li>
<li>setData(byte[] buf)</li>
<li>setLength(int length)</li>
<li>getData()、getOffset()、getLength()</li>
<li>setAddress(InetAddress iaddr)、setPort(int port)</li>
<li>getAddress()、getPort()</li>
<li>setSocketAddress(SocketAddress address)</li>
<li>getSocketAddress()</li>
</ul>
<h4 id="UDP单播、广播、多播"><a href="#UDP单播、广播、多播" class="headerlink" title="UDP单播、广播、多播"></a>UDP单播、广播、多播</h4><p>单播：1对1</p>
<p>多播（组播）：1对多，一次给一个组发</p>
<p>广播：给所有设备发送</p>
<h5 id="IP地址类别"><a href="#IP地址类别" class="headerlink" title="IP地址类别"></a>IP地址类别</h5><p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/6.png" alt></p>
<h5 id="广播地址"><a href="#广播地址" class="headerlink" title="广播地址"></a>广播地址</h5><ul>
<li>255.255.255.255 为受限广播地址</li>
<li>C网广播地址一般为：xxx.xxx.xxx.255(192.168.1.255)</li>
<li>D类IP地址为多播预留</li>
</ul>
<h5 id="IP地址构成"><a href="#IP地址构成" class="headerlink" title="IP地址构成"></a>IP地址构成</h5><p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/7.png" alt></p>
<h5 id="广播地址运算"><a href="#广播地址运算" class="headerlink" title="广播地址运算"></a>广播地址运算</h5><p>比如：</p>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/8.png" alt></p>
<p>根据子网掩码：</p>
<ul>
<li>255.255.255.192 -&gt; 11111111.11111111.11111111.11000000</li>
<li>可划分网段：最后八位2个1，即：2^2 = 4 个</li>
<li>0<del>63、64</del>127、128<del>191、192</del>255</li>
<li>由于例子IP在第一个网段，所以广播地址：192.168.124.63</li>
</ul>
<h5 id="广播通信问题"><a href="#广播通信问题" class="headerlink" title="广播通信问题"></a>广播通信问题</h5><p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/9.png" alt></p>
<p>如图，主机一发送广播后主机二不能收到，因为不在同一个网段，广播地址不一样。</p>
<h4 id="局域网搜索案例"><a href="#局域网搜索案例" class="headerlink" title="局域网搜索案例"></a>局域网搜索案例</h4><ol>
<li><p>UDP接收消息并回送功能实现</p>
<p>UDP接收者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ljh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UDPProvider.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年08月03日</span></span><br><span class="line"><span class="comment"> * UDP服务提供者，用于提供服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"UDPProvider started..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//作为接收者，接收指定为20000端口的数据</span></span><br><span class="line">        DatagramSocket datagramSocket = <span class="keyword">new</span> DatagramSocket(<span class="number">20000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建接收实体</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span>];</span><br><span class="line">        DatagramPacket receivePacket = <span class="keyword">new</span> DatagramPacket(buf, buf.length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接收</span></span><br><span class="line">        datagramSocket.receive(receivePacket);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//打印接收到的信息与发送者的信息</span></span><br><span class="line">        <span class="comment">//发送者的IP地址</span></span><br><span class="line">        String ip = receivePacket.getAddress().getHostAddress();</span><br><span class="line">        <span class="keyword">int</span> port = receivePacket.getPort();</span><br><span class="line">        <span class="keyword">int</span> dataLength = receivePacket.getLength();</span><br><span class="line">        String receiveDate = <span class="keyword">new</span> String(receivePacket.getData(), <span class="number">0</span>, dataLength);</span><br><span class="line">        System.out.println(<span class="string">"UDPProvider receive from ip:"</span>+ip+<span class="string">"\tport:"</span>+port+<span class="string">"\tdata:"</span>+receiveDate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建一份回送数据</span></span><br><span class="line">        String responseData = <span class="string">"Receive data with len :"</span> + dataLength;</span><br><span class="line">        <span class="keyword">byte</span>[] receiveDateBytes = responseData.getBytes();</span><br><span class="line">        <span class="comment">//直接根据发送者构建一份回送信息</span></span><br><span class="line">        DatagramPacket responsePacket = <span class="keyword">new</span> DatagramPacket(receiveDateBytes,</span><br><span class="line">                receiveDateBytes.length,</span><br><span class="line">                receivePacket.getAddress(),</span><br><span class="line">                receivePacket.getPort());</span><br><span class="line"></span><br><span class="line">        datagramSocket.send(responsePacket);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"UDPProvider finished..."</span>);</span><br><span class="line">        datagramSocket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UDP搜索者：搜索提供方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ljh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UDPSearcher.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年08月03日</span></span><br><span class="line"><span class="comment"> * UDP搜索者，用于搜索服务支持方</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPSearcher</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"UDPSearcher started..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//作为搜索方，让系统自动分配端口</span></span><br><span class="line">        DatagramSocket datagramSocket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建一份请求数据</span></span><br><span class="line">        String requestData = <span class="string">"Only the dead do not make mistakes."</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] requestDateBytes = requestData.getBytes();</span><br><span class="line">        <span class="comment">//直接根据发送者构建一份回送信息</span></span><br><span class="line">        DatagramPacket requestPacket = <span class="keyword">new</span> DatagramPacket(requestDateBytes,</span><br><span class="line">                requestDateBytes.length);</span><br><span class="line">        <span class="comment">//发送端的Ip</span></span><br><span class="line">        requestPacket.setAddress(InetAddress.getLocalHost());</span><br><span class="line">        <span class="comment">//目标端口</span></span><br><span class="line">        requestPacket.setPort(<span class="number">20000</span>);</span><br><span class="line">        <span class="comment">//发送</span></span><br><span class="line">        datagramSocket.send(requestPacket);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建接收实体</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span>];</span><br><span class="line">        DatagramPacket receivePacket = <span class="keyword">new</span> DatagramPacket(buf, buf.length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接收</span></span><br><span class="line">        datagramSocket.receive(receivePacket);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//打印接收到的信息与发送者的信息</span></span><br><span class="line">        <span class="comment">//发送者的IP地址</span></span><br><span class="line">        String ip = receivePacket.getAddress().getHostAddress();</span><br><span class="line">        <span class="keyword">int</span> port = receivePacket.getPort();</span><br><span class="line">        <span class="keyword">int</span> dataLength = receivePacket.getLength();</span><br><span class="line">        String receiveDate = <span class="keyword">new</span> String(receivePacket.getData(), <span class="number">0</span>, dataLength);</span><br><span class="line">        System.out.println(<span class="string">"UDPSearcher receive from ip:"</span>+ip+<span class="string">"\tport:"</span>+port+<span class="string">"\tdata:"</span>+receiveDate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"UDPSearcher finished..."</span>);</span><br><span class="line">        datagramSocket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/10.png" alt></p>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/11.png" alt></p>
</li>
<li><p>UDP局域网广播发送实现</p>
</li>
<li><p>UDP局域网回送消息实现</p>
</li>
</ol>
<p>己方，监听20000端口，并回送指定30000端口数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ljh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UDPProvider.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> </span></span><br><span class="line"><span class="comment"> * UDP提供者，用于提供服务,监听端口信息，然后回送</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPProvider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//生成一份唯一标识</span></span><br><span class="line">        String sn = UUID.randomUUID().toString();</span><br><span class="line">        Provider provider = <span class="keyword">new</span> Provider(sn);</span><br><span class="line">        provider.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取任意键信息后可以退出</span></span><br><span class="line">        System.in.read();</span><br><span class="line">        provider.exit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String sn;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">private</span> DatagramSocket datagramSocket = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Provider</span><span class="params">(String sn)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.sn = sn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.run();</span><br><span class="line">            System.out.println(<span class="string">"UDPProvider started..."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//作为接收者，接收指定为20000端口的数据</span></span><br><span class="line">                datagramSocket = <span class="keyword">new</span> DatagramSocket(<span class="number">20000</span>);</span><br><span class="line">                <span class="keyword">while</span> (!done)&#123;</span><br><span class="line">                    <span class="comment">//构建接收实体</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span>];</span><br><span class="line">                    DatagramPacket receivePacket = <span class="keyword">new</span> DatagramPacket(buf, buf.length);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//接收对方暗号</span></span><br><span class="line">                    datagramSocket.receive(receivePacket);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//打印接收到的信息与发送者的信息</span></span><br><span class="line">                    <span class="comment">//发送者的IP地址</span></span><br><span class="line">                    String ip = receivePacket.getAddress().getHostAddress();</span><br><span class="line">                    <span class="keyword">int</span> port = receivePacket.getPort();</span><br><span class="line">                    <span class="keyword">int</span> dataLength = receivePacket.getLength();</span><br><span class="line">                    String receiveData = <span class="keyword">new</span> String(receivePacket.getData(), <span class="number">0</span>, dataLength);</span><br><span class="line">                    System.out.println(<span class="string">"UDPProvider receive from ip:"</span>+ip+<span class="string">"\tport:"</span>+port+<span class="string">"\tdata:"</span>+receiveData);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//对方端口</span></span><br><span class="line">                    <span class="keyword">int</span> responsePort = MessageCreator.parsePort(receiveData);</span><br><span class="line">                    <span class="keyword">if</span> (responsePort != -<span class="number">1</span>)&#123;</span><br><span class="line">                        <span class="comment">//构建一份回送数据</span></span><br><span class="line">                        String responseData = MessageCreator.buildWithSn(sn);</span><br><span class="line">                        <span class="keyword">byte</span>[] receiveDateBytes = responseData.getBytes();</span><br><span class="line">                        <span class="comment">//构建一份回送信息</span></span><br><span class="line">                        DatagramPacket responsePacket = <span class="keyword">new</span> DatagramPacket(receiveDateBytes,</span><br><span class="line">                                receiveDateBytes.length,</span><br><span class="line">                                receivePacket.getAddress(),</span><br><span class="line">                                responsePort);</span><br><span class="line"></span><br><span class="line">                        datagramSocket.send(responsePacket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                close();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"UDPProvider finished..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (datagramSocket != <span class="keyword">null</span>)&#123;</span><br><span class="line">                datagramSocket.close();</span><br><span class="line">                datagramSocket = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">exit</span><span class="params">()</span></span>&#123;</span><br><span class="line">            done = <span class="keyword">true</span>;</span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搜索端，发送20000端口数据暗号，监听30000端口回复</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ljh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> UDPSearcher.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年08月03日</span></span><br><span class="line"><span class="comment"> * UDP搜索者，用于搜索服务支持方</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDPSearcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LISTEN_PORT = <span class="number">30000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//做好监听3000端口的准备，并显示对方回复数据</span></span><br><span class="line">        Listener listen = listen();</span><br><span class="line">        <span class="comment">//给所有监听20000端口的端发送广播，告诉他们给30000端口回复数据</span></span><br><span class="line">        sendBroadcast();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取任意键盘信息退出</span></span><br><span class="line">        System.in.read();</span><br><span class="line">        listen.getDevicesAndClose();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Listener <span class="title">listen</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"UDPSearcher start listen..."</span>);</span><br><span class="line">        CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">        Listener listener = <span class="keyword">new</span> Listener(LISTEN_PORT, countDownLatch);</span><br><span class="line">        listener.start();</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        <span class="keyword">return</span> listener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送广播</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendBroadcast</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"UDPSearcher started..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//作为搜索方，让系统自动分配端口</span></span><br><span class="line">        DatagramSocket datagramSocket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建一份请求数据</span></span><br><span class="line">        String requestData = MessageCreator.buildWithPort(LISTEN_PORT);</span><br><span class="line">        <span class="keyword">byte</span>[] requestDateBytes = requestData.getBytes();</span><br><span class="line">        <span class="comment">//直接根据发送者构建一份回送信息</span></span><br><span class="line">        DatagramPacket requestPacket = <span class="keyword">new</span> DatagramPacket(requestDateBytes,</span><br><span class="line">                requestDateBytes.length);</span><br><span class="line">        <span class="comment">//广播地址</span></span><br><span class="line">        requestPacket.setAddress(InetAddress.getByName(<span class="string">"255.255.255.255"</span>));</span><br><span class="line">        <span class="comment">//发送的目标端口</span></span><br><span class="line">        requestPacket.setPort(<span class="number">20000</span>);</span><br><span class="line">        <span class="comment">//发送</span></span><br><span class="line">        datagramSocket.send(requestPacket);</span><br><span class="line">        datagramSocket.close();</span><br><span class="line">        <span class="comment">//完成</span></span><br><span class="line">        System.out.println(<span class="string">"UDPSearcher finished..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Device</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">final</span> String ip;</span><br><span class="line">        <span class="keyword">final</span> String sn;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Device</span><span class="params">(<span class="keyword">int</span> port, String ip, String sn)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.port = port;</span><br><span class="line">            <span class="keyword">this</span>.ip = ip;</span><br><span class="line">            <span class="keyword">this</span>.sn = sn;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Device&#123;"</span> +</span><br><span class="line">                    <span class="string">"port="</span> + port +</span><br><span class="line">                    <span class="string">", ip='"</span> + ip + <span class="string">'\''</span> +</span><br><span class="line">                    <span class="string">", sn='"</span> + sn + <span class="string">'\''</span> +</span><br><span class="line">                    <span class="string">'&#125;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Listener</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> listenPort;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch countDownLatch;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Device&gt; devices = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">private</span> DatagramSocket ds;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Listener</span><span class="params">(<span class="keyword">int</span> listenPort,CountDownLatch countDownLatch)</span></span>&#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.listenPort = listenPort;</span><br><span class="line">            <span class="keyword">this</span>.countDownLatch = countDownLatch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.run();</span><br><span class="line">            <span class="comment">//通知已经启动</span></span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ds = <span class="keyword">new</span> DatagramSocket(listenPort);</span><br><span class="line">                <span class="keyword">while</span> (!done)&#123;</span><br><span class="line">                    <span class="comment">//构建接收体</span></span><br><span class="line">                    <span class="comment">//构建接收实体</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">512</span>];</span><br><span class="line">                    DatagramPacket receivePacket = <span class="keyword">new</span> DatagramPacket(buf, buf.length);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//接收</span></span><br><span class="line">                    ds.receive(receivePacket);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//打印接收到的信息与发送者的信息</span></span><br><span class="line">                    <span class="comment">//发送者的IP地址</span></span><br><span class="line">                    String ip = receivePacket.getAddress().getHostAddress();</span><br><span class="line">                    <span class="keyword">int</span> port = receivePacket.getPort();</span><br><span class="line">                    <span class="keyword">int</span> dataLength = receivePacket.getLength();</span><br><span class="line">                    String receiveData = <span class="keyword">new</span> String(receivePacket.getData(), <span class="number">0</span>, dataLength);</span><br><span class="line">                    System.out.println(<span class="string">"UDPSearcher receive from ip:"</span>+ip+<span class="string">"\tport:"</span>+port+<span class="string">"\tdata:"</span>+receiveData);</span><br><span class="line"></span><br><span class="line">                    String sn = MessageCreator.parseSn(receiveData);</span><br><span class="line">                    <span class="keyword">if</span> (sn!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                        Device device = <span class="keyword">new</span> Device(port, ip, sn);</span><br><span class="line">                        devices.add(device);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                close();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"UDPSearcher listener finished."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (ds != <span class="keyword">null</span>)&#123;</span><br><span class="line">                ds.close();</span><br><span class="line">                ds = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">exit</span><span class="params">()</span></span>&#123;</span><br><span class="line">            done = <span class="keyword">true</span>;</span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">List&lt;Device&gt; <span class="title">getDevicesAndClose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            done = <span class="keyword">true</span>;</span><br><span class="line">            close();</span><br><span class="line">            <span class="keyword">return</span> devices;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>约定一个通信方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ljh</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> MessageCreater.java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2022年08月04日</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageCreator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SN_HEADER = <span class="string">"收到暗号，我是（SN）："</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PORT_HEADER = <span class="string">"这是暗号，请回电端口（port）："</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建发送暗号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> port</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">buildWithPort</span><span class="params">(<span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PORT_HEADER + port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析收到暗号信息，获取对方端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parsePort</span><span class="params">(String data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data.startsWith(PORT_HEADER))&#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(data.substring(PORT_HEADER.length()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建回复SN暗号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">buildWithSn</span><span class="params">(String sn)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SN_HEADER + sn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析对方回复SN暗号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">parseSn</span><span class="params">(String data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data.startsWith(SN_HEADER))&#123;</span><br><span class="line">            <span class="keyword">return</span> data.substring(SN_HEADER.length());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/12.png" alt></p>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/13.png" alt></p>
<h2 id="Socket-TCP"><a href="#Socket-TCP" class="headerlink" title="Socket TCP"></a>Socket TCP</h2><h3 id="TCP是什么"><a href="#TCP是什么" class="headerlink" title="TCP是什么"></a>TCP是什么</h3><ul>
<li>Transmission Control Protocol(TCP)</li>
<li>TCP是<strong>传输控制协议</strong>，是一种<strong>面向连接、可靠、基于字节流</strong>的传输层通信协议，由IETF的RFC 793定义</li>
</ul>
<h4 id="TCP机制"><a href="#TCP机制" class="headerlink" title="TCP机制"></a>TCP机制</h4><ul>
<li>三次握手、四次挥手</li>
<li>具有校验机制、可靠、数据传输稳定</li>
</ul>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/14.png" alt></p>
<h4 id="TCP能做什么"><a href="#TCP能做什么" class="headerlink" title="TCP能做什么"></a>TCP能做什么</h4><ul>
<li>聊天消息传输、推送</li>
<li>单人语音、视频聊天等</li>
<li>几乎所有UDP能做到的事都能做，但需要考虑复杂性、性能问题</li>
<li>无法进行广播、多播等操作</li>
</ul>
<h3 id="TCP核心API"><a href="#TCP核心API" class="headerlink" title="TCP核心API"></a>TCP核心API</h3><ul>
<li>socket():创建一个Socket</li>
<li>bind():绑定一个Socket到一个本地地址和端口上</li>
<li>connect():连接到远程套接字</li>
<li>accept():接受一个新的连接</li>
<li>write()：把数据写入到Socket输出流</li>
<li>read():从socket输入流读取数据</li>
</ul>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/15.png" alt></p>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/16.png" alt></p>
<h3 id="TCP连接可靠性-三次握手"><a href="#TCP连接可靠性-三次握手" class="headerlink" title="TCP连接可靠性-三次握手"></a>TCP连接可靠性-三次握手</h3><p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/17.png" alt></p>
<p>​        比如打电话：客户端打给服务端说：可以听到我说话吗，然后服务端回复：能听到你说话，你能听到我说话吗，客户端再回复：可以听到。这时，三次握手结束，它们就建立了连接。</p>
<h3 id="TCP四次挥手"><a href="#TCP四次挥手" class="headerlink" title="TCP四次挥手"></a>TCP四次挥手</h3><p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/18.png" alt></p>
<p>​    首先：发送端向接收端说：我想和你断开连接了，接收端回复说OK你可以断开对我的连接了；这时发送端的输出操作可以断开了，读取操作还保留着，服务端会把还没送答的消息一一送达给接收端，送达完成后，接收端会跟发送端说：他想要关闭连接了。发送端回复说：Ok，你可以断开连接了。</p>
<h3 id="传输可靠性"><a href="#传输可靠性" class="headerlink" title="传输可靠性"></a>传输可靠性</h3><ul>
<li>分片发送，排序，顺序发送，顺序组装</li>
<li>丢弃、超时</li>
<li>重发机制-定时器</li>
</ul>
<h3 id="案例实操"><a href="#案例实操" class="headerlink" title="案例实操"></a>案例实操</h3><h4 id="TCP传输初始化配置-传输数据"><a href="#TCP传输初始化配置-传输数据" class="headerlink" title="TCP传输初始化配置/传输数据"></a>TCP传输初始化配置/传输数据</h4><p>Tools.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tools</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">byteArrayToInt</span><span class="params">(<span class="keyword">byte</span>[] b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b[<span class="number">3</span>] &amp; <span class="number">0xFF</span> |</span><br><span class="line">                (b[<span class="number">2</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">8</span> |</span><br><span class="line">                (b[<span class="number">1</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">16</span> |</span><br><span class="line">                (b[<span class="number">0</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] intToByteArray(<span class="keyword">int</span> a) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">                (<span class="keyword">byte</span>) ((a &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>),</span><br><span class="line">                (<span class="keyword">byte</span>) ((a &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>),</span><br><span class="line">                (<span class="keyword">byte</span>) ((a &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>),</span><br><span class="line">                (<span class="keyword">byte</span>) (a &amp; <span class="number">0xFF</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Client:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="comment">//服务器远程端口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">20000</span>;</span><br><span class="line">    <span class="comment">//当前进程端口</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOCAL_PORT = <span class="number">20001</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//创建clientSocket</span></span><br><span class="line">        Socket socket = createSocket();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        initSocket(socket);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 链接到本地20000端口，超时时间3秒，超过则抛出超时异常</span></span><br><span class="line">        socket.connect(<span class="keyword">new</span> InetSocketAddress(Inet4Address.getLocalHost(), PORT), <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"已发起服务器连接，并进入后续流程～"</span>);</span><br><span class="line">        System.out.println(<span class="string">"客户端信息："</span> + socket.getLocalAddress() + <span class="string">" P:"</span> + socket.getLocalPort());</span><br><span class="line">        System.out.println(<span class="string">"服务器信息："</span> + socket.getInetAddress() + <span class="string">" P:"</span> + socket.getPort());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 发送接收数据</span></span><br><span class="line">            todo(socket);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"异常关闭"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 释放资源</span></span><br><span class="line">        socket.close();</span><br><span class="line">        System.out.println(<span class="string">"客户端已退出～"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Socket <span class="title">createSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        // 无代理模式，等效于空构造函数</span></span><br><span class="line"><span class="comment">        Socket socket = new Socket(Proxy.NO_PROXY);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 新建一份具有HTTP代理的套接字，传输数据将通过www.baidu.com:8080端口转发</span></span><br><span class="line"><span class="comment">        Proxy proxy = new Proxy(Proxy.Type.HTTP,</span></span><br><span class="line"><span class="comment">                new InetSocketAddress(Inet4Address.getByName("www.baidu.com"), 8800));</span></span><br><span class="line"><span class="comment">        socket = new Socket(proxy);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 新建一个套接字，并且直接链接到本地20000的服务器上</span></span><br><span class="line"><span class="comment">        socket = new Socket("localhost", PORT);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 新建一个套接字，并且直接链接到本地20000的服务器上</span></span><br><span class="line"><span class="comment">        socket = new Socket(Inet4Address.getLocalHost(), PORT);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // 新建一个套接字，并且直接链接到本地20000的服务器上，并且绑定到本地20001端口上</span></span><br><span class="line"><span class="comment">        socket = new Socket("localhost", PORT, Inet4Address.getLocalHost(), LOCAL_PORT);</span></span><br><span class="line"><span class="comment">        socket = new Socket(Inet4Address.getLocalHost(), PORT, Inet4Address.getLocalHost(), LOCAL_PORT);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket();</span><br><span class="line">        <span class="comment">// 绑定到本地20001端口</span></span><br><span class="line">        socket.bind(<span class="keyword">new</span> InetSocketAddress(Inet4Address.getLocalHost(), LOCAL_PORT));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initSocket</span><span class="params">(Socket socket)</span> <span class="keyword">throws</span> SocketException </span>&#123;</span><br><span class="line">        <span class="comment">// 设置读取超时时间为2秒</span></span><br><span class="line">        socket.setSoTimeout(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否复用未完全关闭的Socket地址，对于指定bind操作后的套接字有效</span></span><br><span class="line">        socket.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否开启Nagle算法,收到所有发送包后再回送收到，而不是收一次回复一次</span></span><br><span class="line">        socket.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否需要在长时无数据响应时发送确认数据（类似心跳包），时间大约为2小时</span></span><br><span class="line">        socket.setKeepAlive(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于close关闭操作行为进行怎样的处理；默认为false，0</span></span><br><span class="line">        <span class="comment">// false、0：默认情况，关闭时立即返回，底层系统接管输出流，将缓冲区内的数据发送完成</span></span><br><span class="line">        <span class="comment">// true、0：关闭时立即返回，缓冲区数据抛弃，直接发送RST结束命令到对方，并无需经过2MSL等待</span></span><br><span class="line">        <span class="comment">// true、200：关闭时最长阻塞200毫秒，随后按第二情况处理</span></span><br><span class="line">        socket.setSoLinger(<span class="keyword">true</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否让紧急数据内敛，默认false；紧急数据通过 socket.sendUrgentData(1);发送</span></span><br><span class="line">        socket.setOOBInline(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置接收发送缓冲器大小</span></span><br><span class="line">        socket.setReceiveBufferSize(<span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        socket.setSendBufferSize(<span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置性能参数：短链接，延迟，带宽的相对重要性（权重）</span></span><br><span class="line">        socket.setPerformancePreferences(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">todo</span><span class="params">(Socket client)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 得到Socket输出流</span></span><br><span class="line">        OutputStream outputStream = client.getOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到Socket输入流</span></span><br><span class="line">        InputStream inputStream = client.getInputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">256</span>];</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.wrap(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// byte</span></span><br><span class="line">        byteBuffer.put((<span class="keyword">byte</span>) <span class="number">126</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// char</span></span><br><span class="line">        <span class="keyword">char</span> c = <span class="string">'a'</span>;</span><br><span class="line">        byteBuffer.putChar(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// int</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">2323123</span>;</span><br><span class="line">        byteBuffer.putInt(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// bool</span></span><br><span class="line">        <span class="keyword">boolean</span> b = <span class="keyword">true</span>;</span><br><span class="line">        byteBuffer.put(b ? (<span class="keyword">byte</span>) <span class="number">1</span> : (<span class="keyword">byte</span>) <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Long</span></span><br><span class="line">        <span class="keyword">long</span> l = <span class="number">298789739</span>;</span><br><span class="line">        byteBuffer.putLong(l);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// float</span></span><br><span class="line">        <span class="keyword">float</span> f = <span class="number">12.345f</span>;</span><br><span class="line">        byteBuffer.putFloat(f);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// double</span></span><br><span class="line">        <span class="keyword">double</span> d = <span class="number">13.31241248782973</span>;</span><br><span class="line">        byteBuffer.putDouble(d);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// String</span></span><br><span class="line">        String str = <span class="string">"Hello你好！"</span>;</span><br><span class="line">        byteBuffer.put(str.getBytes());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送到服务器</span></span><br><span class="line">        outputStream.write(buffer, <span class="number">0</span>, byteBuffer.position() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收服务器返回</span></span><br><span class="line">        <span class="keyword">int</span> read = inputStream.read(buffer);</span><br><span class="line">        System.out.println(<span class="string">"收到数量："</span> + read);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 资源释放</span></span><br><span class="line">        outputStream.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">20000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//创建服务端</span></span><br><span class="line">        ServerSocket server = createServerSocket();</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        initServerSocket(server);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定到本地端口上</span></span><br><span class="line">        server.bind(<span class="keyword">new</span> InetSocketAddress(Inet4Address.getLocalHost(), PORT), <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"服务器准备就绪～"</span>);</span><br><span class="line">        System.out.println(<span class="string">"服务器信息："</span> + server.getInetAddress() + <span class="string">" P:"</span> + server.getLocalPort());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待客户端连接</span></span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="comment">// 得到客户端</span></span><br><span class="line">            Socket client = server.accept();</span><br><span class="line">            <span class="comment">// 客户端构建异步线程</span></span><br><span class="line">            ClientHandler clientHandler = <span class="keyword">new</span> ClientHandler(client);</span><br><span class="line">            <span class="comment">// 启动线程</span></span><br><span class="line">            clientHandler.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ServerSocket <span class="title">createServerSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建基础的ServerSocket</span></span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绑定到本地端口20000上，并且设置当前可允许等待链接的队列为50个</span></span><br><span class="line">        <span class="comment">//serverSocket = new ServerSocket(PORT);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等效于上面的方案，队列设置为50个</span></span><br><span class="line">        <span class="comment">//serverSocket = new ServerSocket(PORT, 50);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 与上面等同</span></span><br><span class="line">        <span class="comment">// serverSocket = new ServerSocket(PORT, 50, Inet4Address.getLocalHost());</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> serverSocket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initServerSocket</span><span class="params">(ServerSocket serverSocket)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 是否复用未完全关闭的地址端口</span></span><br><span class="line">        serverSocket.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等效Socket#setReceiveBufferSize</span></span><br><span class="line">        serverSocket.setReceiveBufferSize(<span class="number">64</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置serverSocket#accept超时时间</span></span><br><span class="line">        <span class="comment">// serverSocket.setSoTimeout(2000);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置性能参数：短链接，延迟，带宽的相对重要性</span></span><br><span class="line">        serverSocket.setPerformancePreferences(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端消息处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">        ClientHandler(Socket socket) &#123;</span><br><span class="line">            <span class="keyword">this</span>.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.run();</span><br><span class="line">            System.out.println(<span class="string">"新客户端连接："</span> + socket.getInetAddress() +</span><br><span class="line">                    <span class="string">" P:"</span> + socket.getPort());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 得到套接字流</span></span><br><span class="line">                OutputStream outputStream = socket.getOutputStream();</span><br><span class="line">                InputStream inputStream = socket.getInputStream();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">256</span>];</span><br><span class="line">                <span class="keyword">int</span> readCount = inputStream.read(buffer);</span><br><span class="line">                ByteBuffer byteBuffer = ByteBuffer.wrap(buffer, <span class="number">0</span>, readCount);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// byte</span></span><br><span class="line">                <span class="keyword">byte</span> be = byteBuffer.get();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// char</span></span><br><span class="line">                <span class="keyword">char</span> c = byteBuffer.getChar();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// int</span></span><br><span class="line">                <span class="keyword">int</span> i = byteBuffer.getInt();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// bool</span></span><br><span class="line">                <span class="keyword">boolean</span> b = byteBuffer.get() == <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Long</span></span><br><span class="line">                <span class="keyword">long</span> l = byteBuffer.getLong();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// float</span></span><br><span class="line">                <span class="keyword">float</span> f = byteBuffer.getFloat();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// double</span></span><br><span class="line">                <span class="keyword">double</span> d = byteBuffer.getDouble();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// String</span></span><br><span class="line">                <span class="keyword">int</span> pos = byteBuffer.position();</span><br><span class="line">                String str = <span class="keyword">new</span> String(buffer, pos, readCount - pos - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"收到数量："</span> + readCount + <span class="string">" 数据："</span></span><br><span class="line">                        + be + <span class="string">"\n"</span></span><br><span class="line">                        + c + <span class="string">"\n"</span></span><br><span class="line">                        + i + <span class="string">"\n"</span></span><br><span class="line">                        + b + <span class="string">"\n"</span></span><br><span class="line">                        + l + <span class="string">"\n"</span></span><br><span class="line">                        + f + <span class="string">"\n"</span></span><br><span class="line">                        + d + <span class="string">"\n"</span></span><br><span class="line">                        + str + <span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">                outputStream.write(buffer, <span class="number">0</span>, readCount);</span><br><span class="line">                outputStream.close();</span><br><span class="line">                inputStream.close();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"连接异常断开"</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 连接关闭</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"客户端已退出："</span> + socket.getInetAddress() +</span><br><span class="line">                    <span class="string">" P:"</span> + socket.getPort());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/19.png" alt></p>
<p><img src="/2022/08/02/UDP%E4%B8%8ETCP%E5%85%A5%E9%97%A8/20.png" alt></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag"># 网络编程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/07/15/%E5%BD%B1%E5%83%8F%E8%AE%B0%E5%BD%95/" rel="prev" title="影像记录">
      <i class="fa fa-chevron-left"></i> 影像记录
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/08/09/Appcompat%20UI%E7%BB%84%E4%BB%B6/" rel="next" title="Appcompat UI组件">
      Appcompat UI组件 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#报文、协议、Mac地址"><span class="nav-number">1.</span> <span class="nav-text">报文、协议、Mac地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IP、端口以及远程服务器"><span class="nav-number">2.</span> <span class="nav-text">IP、端口以及远程服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Socket-UDP"><span class="nav-number">3.</span> <span class="nav-text">Socket UDP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UDP是什么"><span class="nav-number">3.1.</span> <span class="nav-text">UDP是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#为什么不可靠"><span class="nav-number">3.1.0.1.</span> <span class="nav-text">为什么不可靠</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UDP能做什么"><span class="nav-number">3.1.0.2.</span> <span class="nav-text">UDP能做什么</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UDP包最大长度"><span class="nav-number">3.1.0.3.</span> <span class="nav-text">UDP包最大长度</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UDP核心API"><span class="nav-number">3.1.1.</span> <span class="nav-text">UDP核心API</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#API-DatagramSocket"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">API-DatagramSocket</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#API-DatagramPacket"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">API-DatagramPacket</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UDP单播、广播、多播"><span class="nav-number">3.1.2.</span> <span class="nav-text">UDP单播、广播、多播</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#IP地址类别"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">IP地址类别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#广播地址"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">广播地址</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#IP地址构成"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">IP地址构成</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#广播地址运算"><span class="nav-number">3.1.2.4.</span> <span class="nav-text">广播地址运算</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#广播通信问题"><span class="nav-number">3.1.2.5.</span> <span class="nav-text">广播通信问题</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#局域网搜索案例"><span class="nav-number">3.1.3.</span> <span class="nav-text">局域网搜索案例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Socket-TCP"><span class="nav-number">4.</span> <span class="nav-text">Socket TCP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP是什么"><span class="nav-number">4.1.</span> <span class="nav-text">TCP是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP机制"><span class="nav-number">4.1.1.</span> <span class="nav-text">TCP机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP能做什么"><span class="nav-number">4.1.2.</span> <span class="nav-text">TCP能做什么</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP核心API"><span class="nav-number">4.2.</span> <span class="nav-text">TCP核心API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP连接可靠性-三次握手"><span class="nav-number">4.3.</span> <span class="nav-text">TCP连接可靠性-三次握手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP四次挥手"><span class="nav-number">4.4.</span> <span class="nav-text">TCP四次挥手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#传输可靠性"><span class="nav-number">4.5.</span> <span class="nav-text">传输可靠性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例实操"><span class="nav-number">4.6.</span> <span class="nav-text">案例实操</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP传输初始化配置-传输数据"><span class="nav-number">4.6.1.</span> <span class="nav-text">TCP传输初始化配置&#x2F;传输数据</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="余一"
      src="/images/avatar5.jpg">
  <p class="site-author-name" itemprop="name">余一</p>
  <div class="site-description" itemprop="description">纸上得来终觉浅，绝知此事要躬行。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">172</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.bilibili.com/" title="https:&#x2F;&#x2F;www.bilibili.com&#x2F;" rel="noopener" target="_blank">Bilibili</a>
        </li>
    </ul>
  </div>

	
           
         
         <div style="">
  <canvas id="canvas" style="width:60%;">��ǰ�������֧��canvas������������������</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //����canvas�Ŀ���
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //�洢ʱ������
    var data = [];
    //�洢�˶���С��
    var balls = [];
    //�������Ӱ뾶
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //�洢ʱ�����֣���ʮλСʱ����λСʱ��ð�š�ʮλ���ӡ���λ���ӡ�ð�š�ʮλ���ӡ���λ������7���������
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*���ɵ�������*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*����ʱ��*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //ʱ�䷢���仯
            if(NewData[i] !== data[i]){
                //���仯������ֵ����data�����е������洢��changeNumArray������
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //����С��
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*����С��״̬*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*����Ҫ�˶���С��*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*��Ⱦ*/
    function render(){
        //���û������ȣ��ﵽ��ջ�����Ч��
        canvas.height = 100;
        //��Ⱦʱ��
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //��ȾС��
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //����ʱ��
        updateDigitTime();
        //����С��״̬
        updateBalls();
        //��Ⱦ
        render();
    },50);
}

})();
</script>
      </div>
	
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">余一</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:38</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

  <script async src="/js/cursor/fireworks.js"></script>

</body>
</html>
