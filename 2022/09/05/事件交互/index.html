<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hluck.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="按键事件1.检测软键盘​        手机上的输入按键一般不另外处理，直接由系统按照默认情况操作。有时为了改善用户体验，需要让App拦截按键事件，并进行额外处理。拦截输入字符可通过注册文本观测器TextWatcher实现，但该监听器只适用于编辑框控件，无法用于其他控件。因此，若想让其他控件也能监听按键操作，则要另外调用控件对象的setOnKeyListener方法设置按键监听器，并实现监听器接口">
<meta property="og:type" content="article">
<meta property="og:title" content="事件交互">
<meta property="og:url" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/index.html">
<meta property="og:site_name" content="余一">
<meta property="og:description" content="按键事件1.检测软键盘​        手机上的输入按键一般不另外处理，直接由系统按照默认情况操作。有时为了改善用户体验，需要让App拦截按键事件，并进行额外处理。拦截输入字符可通过注册文本观测器TextWatcher实现，但该监听器只适用于编辑框控件，无法用于其他控件。因此，若想让其他控件也能监听按键操作，则要另外调用控件对象的setOnKeyListener方法设置按键监听器，并实现监听器接口">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/1.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/2.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/3.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/4.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/5.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/6.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/7.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/8.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/9.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/10.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/11.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/12.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/13.png">
<meta property="og:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/14.png">
<meta property="article:published_time" content="2022-09-05T01:25:31.444Z">
<meta property="article:modified_time" content="2022-09-11T05:11:32.096Z">
<meta property="article:author" content="余一">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/1.png">

<link rel="canonical" href="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>事件交互 | 余一</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="余一" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">余一</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">纸上得来终觉浅，绝知此事要躬行。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hluck.github.io/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar5.jpg">
      <meta itemprop="name" content="余一">
      <meta itemprop="description" content="纸上得来终觉浅，绝知此事要躬行。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="余一">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          事件交互
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-05 09:25:31" itemprop="dateCreated datePublished" datetime="2022-09-05T09:25:31+08:00">2022-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-11 13:11:32" itemprop="dateModified" datetime="2022-09-11T13:11:32+08:00">2022-09-11</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>48k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>43 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="按键事件"><a href="#按键事件" class="headerlink" title="按键事件"></a>按键事件</h2><h3 id="1-检测软键盘"><a href="#1-检测软键盘" class="headerlink" title="1.检测软键盘"></a>1.检测软键盘</h3><p>​        手机上的输入按键一般不另外处理，直接由系统按照默认情况操作。有时为了改善用户体验，需要让App拦截按键事件，并进行额外处理。拦截输入字符可通过注册文本观测器TextWatcher实现，但该监听器只适用于编辑框控件，无法用于其他控件。因此，<strong>若想让其他控件也能监听按键操作，则要另外调用控件对象的setOnKeyListener方法设置按键监听器，并实现监听器接口OnKeyListener的onKey方法。</strong></p>
<p>​        监控按键事件之前，首先要知道每个按键的编码，这样才能根据不同的编码值进行相应的处理。按键编码的取值说明见表2-1。注意，监听器OnKeyListener只会检测控制键，不会检测文本键（字母、数字、标点等）。</p>
<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/1.png" alt></p>
<p>​        实际监控结果显示，每次按下控制键时，onKey方法都会收到两次重复编码的按键事件，这是因为该方法把每次按键都分成按下与松开两个动作，所以一次按键变成了两个按键动作。解决这个问题的办法很简单，就是只监控按下动作（KeyEvent.ACTION_DOWN）的按键事件，不监控松开动作（KeyEvent.ACTION_UP）的按键事件。</p>
<p>​        虽然按键编码表存在主页键、任务键、电源键的定义，但这3个键并不开放给普通App，普通App也不应该拦截这些按键事件。</p>
<p>相关代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeySoftActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityKeySoftBinding</span>&gt;</span>(),View.OnKeyListener &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> desc = <span class="string">""</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityKeySoftBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        etSoft.setOnKeyListener(<span class="keyword">this</span><span class="symbol">@KeySoftActivity</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onKey</span><span class="params">(v: <span class="type">View</span>?, keyCode: <span class="type">Int</span>, event: <span class="type">KeyEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event?.action == KeyEvent.ACTION_DOWN)&#123;</span><br><span class="line">            desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>软按键编码是<span class="subst">$&#123;keyCode&#125;</span>，动作是按下"</span></span><br><span class="line">            <span class="keyword">when</span>(keyCode)&#123;</span><br><span class="line">                KeyEvent.KEYCODE_ENTER -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>,按键为回车键"</span></span><br><span class="line">                KeyEvent.KEYCODE_DEL -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>,按键为删除键"</span></span><br><span class="line">                KeyEvent.KEYCODE_SEARCH -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>,按键为搜索键"</span></span><br><span class="line">                KeyEvent.KEYCODE_BACK -&gt; &#123;</span><br><span class="line">                    desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>,按键为返回键"</span></span><br><span class="line">                    <span class="comment">//延迟3s后启动页面关闭任务</span></span><br><span class="line">                    Handler(Looper.myLooper()!!).postDelayed(&#123;finish()&#125;,<span class="number">3000</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                KeyEvent.KEYCODE_VOLUME_UP -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>,按键为加大音量键"</span></span><br><span class="line">                KeyEvent.KEYCODE_VOLUME_DOWN -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>,按键为减小音量键"</span></span><br><span class="line">            &#125;</span><br><span class="line">            desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>\n"</span></span><br><span class="line">            mBinding.tvResult.text = desc</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 返回true表示处理完了不再输入该字符，返回false表示给你输入该字符吧</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="2-检测物理按键"><a href="#2-检测物理按键" class="headerlink" title="2.检测物理按键"></a>2.检测物理按键</h3><p>​        除了给控件注册按键监听器外，还可以在活动页面上检测物理按键，即重写Activity的onKeyDown方法。onKeyDown方法与前面的onKey方法类似，同样拥有按键编码与按键事件KeyEvent两个参数。当然，这两个方法也存在不同之处，具体说明如下：</p>
<ol>
<li>onKeyDown只能在活动代码中使用，而onKey只要有可注册的控件就能使用。</li>
<li>onKeyDown只能检测物理按键，无法检测输入法按键（如回车键、删除键等），onKey可同时检测两类按键。</li>
<li>onKeyDown不区分按下与松开两个动作，onKey区分这两个动作。</li>
</ol>
<p>相关代码，分别检测到了加大音量键、减小音量键、返回键：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeyHardActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityKeyHardBinding</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> desc = <span class="string">""</span></span><br><span class="line">    <span class="comment">// 声明一个返回桌面的广播接收器对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mDesktopReceiver:DesktopReceiver</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityKeyHardBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        initDesktopReceiver()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在发生物理按键动作时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onKeyDown</span><span class="params">(keyCode: <span class="type">Int</span>, event: <span class="type">KeyEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>物理按键的编码是<span class="subst">$&#123;keyCode&#125;</span>"</span></span><br><span class="line">        <span class="keyword">when</span>(keyCode)&#123;</span><br><span class="line">            KeyEvent.KEYCODE_BACK -&gt; &#123;</span><br><span class="line">                desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>，按键为返回键"</span></span><br><span class="line">                <span class="comment">// 延迟3秒后启动页面关闭任务</span></span><br><span class="line">                Handler(Looper.myLooper()!!).postDelayed(&#123;finish()&#125;,<span class="number">3000</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            KeyEvent.KEYCODE_VOLUME_UP -&gt; &#123;</span><br><span class="line">                desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>，按键为加大音量键"</span></span><br><span class="line">            &#125;</span><br><span class="line">            KeyEvent.KEYCODE_VOLUME_DOWN -&gt; &#123;</span><br><span class="line">                desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>，按键为减小音量键"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        desc += <span class="string">"\n"</span></span><br><span class="line">        mBinding.tvResult.text = desc</span><br><span class="line">        <span class="comment">// 返回true表示不再响应系统动作，返回false表示继续响应系统动作</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化桌面广播。用于监听按下主页键和任务键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initDesktopReceiver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 创建一个返回桌面的广播接收器</span></span><br><span class="line">        mDesktopReceiver = DesktopReceiver()</span><br><span class="line">        <span class="comment">// 创建一个意图过滤器，只接收关闭系统对话框（即返回桌面）的广播</span></span><br><span class="line">        <span class="keyword">val</span> intentFilter = IntentFilter(Intent.ACTION_CLOSE_SYSTEM_DIALOGS)</span><br><span class="line">        <span class="comment">// 注册广播接收器</span></span><br><span class="line">        registerReceiver(mDesktopReceiver,intentFilter)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">        <span class="comment">// 注销广播接收器</span></span><br><span class="line">        unregisterReceiver(mDesktopReceiver)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个返回到桌面的广播接收器</span></span><br><span class="line">    <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">DesktopReceiver</span>:<span class="type">BroadcastReceiver</span></span>()&#123;</span><br><span class="line">        <span class="comment">//键名</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> SYSTEM_DIALOG_REASON_KEY = <span class="string">"reason"</span></span><br><span class="line">        <span class="comment">// 主页键</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> SYSTEM_DIALOG_REASON_HOME = <span class="string">"homekey"</span></span><br><span class="line">        <span class="comment">// 任务键</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> SYSTEM_DIALOG_REASON_TASK = <span class="string">"recentapps"</span></span><br><span class="line">        <span class="comment">// 在收到返回桌面广播时触发</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceive</span><span class="params">(context: <span class="type">Context</span>?, intent: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (intent?.action.equals(Intent.ACTION_CLOSE_SYSTEM_DIALOGS))&#123;</span><br><span class="line">                <span class="keyword">var</span> reason = intent?.getStringExtra(SYSTEM_DIALOG_REASON_KEY)</span><br><span class="line">                <span class="keyword">if</span> (!TextUtils.isEmpty(reason))&#123;</span><br><span class="line">                    <span class="comment">//按下了主页键</span></span><br><span class="line">                    <span class="keyword">if</span> (reason.equals(SYSTEM_DIALOG_REASON_HOME))&#123;</span><br><span class="line">                        desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span>\t 按键为主页键\n"</span></span><br><span class="line">                        mBinding.tvResult.text = desc</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reason.equals(SYSTEM_DIALOG_REASON_TASK))&#123; <span class="comment">// 按下了任务键</span></span><br><span class="line">                        desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span>\t 按键为任务键\n"</span></span><br><span class="line">                        mBinding.tvResult.text = desc</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-接管返回按键"><a href="#3-接管返回按键" class="headerlink" title="3.接管返回按键"></a>3.接管返回按键</h3><p>​        检测物理按键最常见的应用是淘宝首页的“再按一次返回键退出”，在App首页按返回键，系统默认的做法是直接退出该App。有时用户有可能是不小心按了返回键，并非想退出该App，因此这里加一个小提示，等待用户再次按返回键才会确认退出意图，并执行退出操作。</p>
<p>​        “再按一次返回键退出”的实现代码很简单，在onKeyDown方法中拦截返回键即可，或者重写活动代码的onBackPressed方法也能实现同样的效果，该方法专门响应按返回键事件</p>
<p>具体代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BackPressActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityBackPressBinding</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="comment">// 是否退出当前页面</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> needExit = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityBackPressBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        tlHead.title = <span class="string">"返回按键"</span></span><br><span class="line">        <span class="comment">// 替换系统自带的ActionBar</span></span><br><span class="line">        setSupportActionBar(tlHead)</span><br><span class="line">        <span class="comment">// 设置工具栏左侧导航图标的点击监听器</span></span><br><span class="line">        tlHead.setNavigationOnClickListener &#123; finish() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在按下返回键时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBackPressed</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onBackPressed()</span><br><span class="line">        <span class="keyword">if</span> (needExit) &#123;</span><br><span class="line">            finish()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        needExit = <span class="literal">true</span></span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>,<span class="string">"再按一次返回键退出!"</span>,Toast.LENGTH_SHORT).show()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在发生物理按键动作时触发</span></span><br><span class="line"><span class="comment">//    override fun onKeyDown(keyCode: Int, event: KeyEvent?): Boolean &#123;</span></span><br><span class="line"><span class="comment">//        // 按下返回键</span></span><br><span class="line"><span class="comment">//        if (keyCode == KeyEvent.KEYCODE_BACK)&#123;</span></span><br><span class="line"><span class="comment">//            if (needExit)&#123;</span></span><br><span class="line"><span class="comment">//                finish()</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//            needExit = true</span></span><br><span class="line"><span class="comment">//            Toast.makeText(this, "再按一次返回键退出!", Toast.LENGTH_SHORT).show()</span></span><br><span class="line"><span class="comment">//            return true</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return super.onKeyDown(keyCode, event)</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="触摸事件"><a href="#触摸事件" class="headerlink" title="触摸事件"></a>触摸事件</h2><h3 id="1-手势事件的分发流程"><a href="#1-手势事件的分发流程" class="headerlink" title="1.手势事件的分发流程"></a>1.手势事件的分发流程</h3><p>​        为方便开发者使用，Android已可自动识别特定的几种触摸手势，包括按钮的点击事件、长按事件、滚动视图的上下滚动事件、翻页视图的左右翻页事件等。不过对于App的高级开发来说，系统自带的几个固定手势显然无法满足丰富多变的业务需求。这就要求开发者深入了解触摸行为的流程与方法，并在合适的场合接管触摸行为，进行符合需求的事件处理。</p>
<p>​        <strong>与手势事件有关的方法主要有3个（按执行顺序排列）</strong>，分别说明如下：</p>
<ul>
<li><strong>dispatchTouchEvent</strong>：进行<strong>事件分发</strong>处理，返回结果表示该事件是否需要分发。默认返回true表示分发给子视图，由子视图处理该手势，不过最终是否分发成功还得根据onInterceptTouchEvent方法的拦截判断结果；返回false表示不分发，此时必须实现自身的onTouchEvent方法，否则该手势将不会得到处理。</li>
<li><strong>onInterceptTouchEvent</strong>：进行<strong>事件拦截</strong>处理，返回结果表示当前容器是否需要拦截该事件。返回true表示予以拦截，该手势不会分发给子视图，此时必须实现自身的onTouchEvent方法，否则该手势将不会得到处理；默认返回false表示不拦截，该手势会分发给子视图进行后续处理。</li>
<li><strong>onTouchEvent</strong>：进行<strong>事件触摸</strong>处理，返回结果表示该事件是否处理完毕。返回true表示处理完毕，无须处理上一级视图的onTouchEvent方法，一路返回结束流程；返回false表示该手势事件尚未完成，返回继续处理上一级视图的onTouchEvent方法，然后根据上一级onTouchEvent方法的返回值判断直接结束或由上上一级处理。</li>
</ul>
<p>上述手势方法的执行者有3个（按执行顺序排列），具体说明如下：</p>
<ul>
<li>页面类：包括Activity及其派生类。<strong>页面类可调用dispatchTouchEvent和onTouchEvent两个方法</strong>。</li>
<li>容器类：包括从ViewGroup类派生出的各类容器，如各种布局Layout和ListView、GridView、Spinner、ViewPager、RecyclerView、Toolbar等。<strong>容器类可调用dispatchTouchEvent、onInterceptTouchEvent和onTouchEvent三个方法。</strong></li>
<li>控件类：包括从View类派生的各类控件，如TextView、ImageView、Button等。<strong>控件类可调用dispatchTouchEvent和onTouchEvent两个方法。</strong></li>
</ul>
<p>​       只有容器类才能调用onInterceptTouchEvent方法，这是因为该方法用于拦截发往下层视图的事件，而控件类已经位于底层，只能被拦截，不能拦截别人。页面类没有下层视图，所以不能调用onInterceptTouchEvent方法。</p>
<p>三类执行者的手势处理流程如图2-4所示。</p>
<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/2.png" alt></p>
<p>​        以上流程图涉及3个手势方法和3种手势执行者，尤其是手势流程的排列组合千变万化，并不容易解释清楚。对于实际开发来说，真正需要处理的组合并不多，所以只要把常见的几种组合搞清楚就能应付大部分开发工作，这几种组合说明如下。</p>
<ol>
<li>页面类的手势处理。它的dispatchTouchEvent方法必须返回super.dispatchTouchEvent，如果不分发，页面上的视图就无法处理手势。至于页面类的onTouchEvent方法，基本没有什么作用，因为手势动作要由具体视图处理，页面直接处理手势没有什么意义。所以，页面类的手势处理可以不用关心，直接略过。</li>
<li>控件类的手势处理。它的dispatchTouchEvent方法没有任何作用，因为控件下面没有子视图，无所谓分不分发。<strong>至于控件类的onTouchEvent方法，如果要进行手势处理，就需要自定义一个控件，重写自定义类中的onTouchEvent方法；如果不想自定义控件，就直接调用控件对象的setOnTouchListener方法，注册一个触摸监听器OnTouchListener，并实现该监听器的onTouch方法。所以，控件类的手势处理只需关心onTouchEvent方法。</strong></li>
<li>容器类的手势处理。这才是真正要深入了解的地方。<strong>容器类的dispatchTouchEvent与onInterceptTouchEvent方法都能决定是否将手势交给子视图处理。为了避免手势响应冲突，一般要重写dispatchTouchEvent或者onInterceptTouchEvent方法。两个方法的区别可以这么理解：前者是大领导，只管派发任务，不会自己做事情；后者是小领导，尽管有拦截的权利，不过也得自己做点事情，比如处理纠纷等。容器类的onTouchEvent方法近乎摆设，因为需要拦截的在前面已经拦截了，需要处理的在子视图已经处理了。</strong></li>
</ol>
<p>经过上面的详细分析，常见的手势处理方法有下面3种：</p>
<ol>
<li>页面类的dispatchTouchEvent方法：控制事件的分发，决定把手势交给谁处理。</li>
<li>容器类的onInterceptTouchEvent方法：控制事件的拦截，决定是否要把手势交给子视图处理。</li>
<li>控件类的onTouchEvent方法：进行手势事件的具体处理。</li>
</ol>
<p><strong>为方便理解dispatchTouchEvent方法，先看下面不派发事件的自定义布局代码：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：不派发事件的自定义布局代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotDispatchLayout</span></span>(context:Context,attrs:AttributeSet):LinearLayout(context, attrs) &#123;</span><br><span class="line">    <span class="comment">// 声明一个分发监听器对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mListener:NotDispatchListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setNotDispatchListener</span><span class="params">(listener: <span class="type">NotDispatchListener</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mListener = listener</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在分发触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        mListener?.onNotDispatch()</span><br><span class="line">        <span class="comment">// 一般容器默认返回true，即允许分发给下级</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个分发监听器接口</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">NotDispatchListener</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onNotDispatch</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Activity:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventDispatchActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityEventDispatchBinding</span>&gt;</span>(),NotDispatchLayout.NotDispatchListener &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> desc_yes = <span class="string">""</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> desc_no = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityEventDispatchBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 设置不分发布局的事件分发监听器</span></span><br><span class="line">        ndlNo.setNotDispatchListener(<span class="keyword">this</span><span class="symbol">@EventDispatchActivity</span>)</span><br><span class="line">        btnDispatchYes.setOnClickListener &#123;</span><br><span class="line">            desc_yes = <span class="string">"<span class="subst">$&#123;desc_yes&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span> 您点击了按钮\n"</span></span><br><span class="line">            tvDispatchYes.text = desc_yes</span><br><span class="line">        &#125;</span><br><span class="line">        btnDispatchNo.setOnClickListener &#123;</span><br><span class="line">            desc_no = <span class="string">"<span class="subst">$&#123;desc_no&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span> 您点击了按钮\n"</span></span><br><span class="line">            tvDispatchNo.text = desc_no</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在分发触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onNotDispatch</span><span class="params">()</span></span> &#123;</span><br><span class="line">        desc_no = <span class="string">"<span class="subst">$&#123;desc_no&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span> 触摸动作未分发，按钮点击不了了\n"</span></span><br><span class="line">        mBinding.tvDispatchNo.text = desc_no</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/3.png" alt></p>
<p><strong>为方便理解onInterceptTouchEvent方法，再看拦截事件的自定义布局代码：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：拦截事件的自定义布局代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterceptLayout</span></span>(context: Context,attr:AttributeSet):LinearLayout(context,attr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mListener:InterceptListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在拦截触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        mListener?.onInterceptor()</span><br><span class="line">        <span class="comment">// 一般容器默认返回false，即不拦截。但滚动视图会拦截</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setInterceptListener</span><span class="params">(listener: <span class="type">InterceptListener</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mListener = listener</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个拦截监听器接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InterceptListener</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptor</span><span class="params">()</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>activity:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.eventstudy.ui</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> com.example.eventstudy.R</span><br><span class="line"><span class="keyword">import</span> com.example.eventstudy.databinding.ActivityEventInterceptBinding</span><br><span class="line"><span class="keyword">import</span> com.example.eventstudy.util.DateUtil</span><br><span class="line"><span class="keyword">import</span> com.example.eventstudy.widget.InterceptLayout</span><br><span class="line"><span class="keyword">import</span> com.example.imageprocess.base.BaseActivity</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventInterceptActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityEventInterceptBinding</span>&gt;</span>(),InterceptLayout.InterceptListener &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> descYes = <span class="string">""</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> descNo = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityEventInterceptBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ilYes.setInterceptListener(<span class="keyword">this</span><span class="symbol">@EventInterceptActivity</span>)</span><br><span class="line">        btnInterceptNo.setOnClickListener &#123;</span><br><span class="line">            descNo = <span class="string">"<span class="subst">$&#123;descNo&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span>您点击了按钮\n"</span></span><br><span class="line">            mBinding.tvInterceptNo.text = descNo</span><br><span class="line">        &#125;</span><br><span class="line">        btnInterceptYes.setOnClickListener &#123;</span><br><span class="line">            descYes = <span class="string">"<span class="subst">$&#123;descYes&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span>您点击了按钮\n"</span></span><br><span class="line">            mBinding.tvInterceptYes.text = descYes</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptor</span><span class="params">()</span></span> &#123;</span><br><span class="line">        descYes = <span class="string">"<span class="subst">$&#123;descYes&#125;</span><span class="subst">$&#123;DateUtil.getNowTime()&#125;</span>触摸动作被拦截，按钮点击不了了\n"</span></span><br><span class="line">        mBinding.tvInterceptYes.text = descYes</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/4.png" alt></p>
<h3 id="2-接管手势事件处理"><a href="#2-接管手势事件处理" class="headerlink" title="2.接管手势事件处理"></a>2.接管手势事件处理</h3><p>​        dispatchTouchEvent、onInterceptTouchEvent和onTouchEvent三个方法的输入参数都是手势事件<strong>MotionEvent</strong>，其中包含触摸动作的所有信息，各种手势操作都从MotionEvent中获取触摸信息并判断处理。</p>
<p>下面是MotionEvent的常用方法：</p>
<ul>
<li>getAction：获取当前的动作类型。动作类型的取值说明见表2-2。</li>
</ul>
<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/5.png" alt></p>
<ul>
<li>getEventTime：获取事件时间（从开机到现在的毫秒数）。</li>
<li>getX：获取在控件内部的相对横坐标。</li>
<li>getY：获取在控件内部的相对纵坐标。</li>
<li>getRawX：获取在屏幕上的绝对横坐标。</li>
<li>getRawY：获取在屏幕上的绝对纵坐标。</li>
<li>getPressure：获取触摸的压力大小。</li>
<li>getPointerCount：获取触控点的数量，如果为2就表示有两个手指同时按压屏幕。如果触控点数目大于1，坐标相关方法就可以输入整数编号，表示获取第几个触控点的坐标信息。</li>
</ul>
<p>为方便理解MotionEvent的各类触摸行为，下面是<strong>单点触摸</strong>的示例代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TouchSingleActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityTouchSingleBinding</span>&gt;</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityTouchSingleBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在发生触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> desc = <span class="string">""</span></span><br><span class="line">        <span class="comment">// 从开机到现在的毫秒数</span></span><br><span class="line">        event?.apply &#123;</span><br><span class="line">            <span class="keyword">var</span> seconds = (eventTime / <span class="number">1000</span>).toInt()</span><br><span class="line">            desc = <span class="string">"动作发生时间：开机距离现在<span class="subst">$&#123;seconds/<span class="number">3600</span>&#125;</span>:<span class="subst">$&#123;seconds % <span class="number">3600</span> / <span class="number">60</span>&#125;</span>:<span class="subst">$&#123;seconds % <span class="number">60</span>&#125;</span>"</span></span><br><span class="line">            desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>\n动作名称是："</span></span><br><span class="line">            <span class="comment">// 获得触摸事件的动作类型</span></span><br><span class="line">            <span class="keyword">when</span>(event.action)&#123;</span><br><span class="line">                <span class="comment">// 按下手指</span></span><br><span class="line">                MotionEvent.ACTION_DOWN -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>按下"</span></span><br><span class="line">                <span class="comment">// 移动手指</span></span><br><span class="line">                MotionEvent.ACTION_MOVE -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>移动"</span></span><br><span class="line">                <span class="comment">// 松开手指</span></span><br><span class="line">                MotionEvent.ACTION_UP -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>提起"</span></span><br><span class="line">                <span class="comment">// 取消手势</span></span><br><span class="line">                MotionEvent.ACTION_CANCEL -&gt; desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>取消"</span></span><br><span class="line">            &#125;</span><br><span class="line">            desc = <span class="string">"<span class="subst">$&#123;desc&#125;</span>\n动作发生位置是：横坐标<span class="subst">$&#123;event.x&#125;</span>，纵坐标<span class="subst">$&#123;event.y&#125;</span>，压力为<span class="subst">$&#123;event.pressure&#125;</span>"</span></span><br><span class="line">        &#125;</span><br><span class="line">        mBinding.tvTouch.text = desc</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/6.png" alt></p>
<p>除了单点触摸，智能手机还普遍支持<strong>多点触控</strong>，即响应两个及以上手指同时按压屏幕。下面是处理多点触控的示例代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TouchMultipleActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityTouchMultipleBinding</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="comment">// 次要点是否按下</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isMinorDown = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityTouchMultipleBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> desc_major = <span class="string">""</span></span><br><span class="line">        <span class="keyword">var</span> desc_minor = <span class="string">""</span></span><br><span class="line">       event?.apply &#123;</span><br><span class="line">           <span class="comment">// 从开机到现在的毫秒数</span></span><br><span class="line">           <span class="keyword">var</span> seconds = (eventTime/<span class="number">1000</span>).toInt()</span><br><span class="line">           desc_major = <span class="string">"主要动作发生时间：开机距离现在<span class="subst">$&#123;seconds / <span class="number">3600</span>&#125;</span>:<span class="subst">$&#123;seconds % <span class="number">3600</span>&#125;</span>:<span class="subst">$&#123;seconds % <span class="number">60</span>&#125;</span>\n主要动作名称是："</span></span><br><span class="line">           isMinorDown = pointerCount &gt;= <span class="number">2</span></span><br><span class="line">           <span class="comment">// 获得包括次要点在内的触摸行为</span></span><br><span class="line">           <span class="keyword">var</span> action:<span class="built_in">Int</span> = action.and(MotionEvent.ACTION_MASK)</span><br><span class="line">           <span class="keyword">when</span>(action)&#123;</span><br><span class="line">               <span class="comment">// 按下手指</span></span><br><span class="line">               MotionEvent.ACTION_DOWN -&gt; desc_major = <span class="string">"<span class="subst">$&#123;desc_major&#125;</span>按下"</span></span><br><span class="line">               <span class="comment">// 移动手指</span></span><br><span class="line">               MotionEvent.ACTION_MOVE -&gt; desc_major = <span class="string">"<span class="subst">$&#123;desc_major&#125;</span>移动"</span></span><br><span class="line">               <span class="comment">// 松开手指</span></span><br><span class="line">               MotionEvent.ACTION_UP -&gt; desc_major = <span class="string">"<span class="subst">$&#123;desc_major&#125;</span>提起"</span></span><br><span class="line">               <span class="comment">// 取消手势</span></span><br><span class="line">               MotionEvent.ACTION_CANCEL -&gt; desc_major = <span class="string">"<span class="subst">$&#123;desc_major&#125;</span>取消"</span></span><br><span class="line">               <span class="comment">// 次要点按下</span></span><br><span class="line">               MotionEvent.ACTION_POINTER_DOWN -&gt; desc_minor = <span class="string">"<span class="subst">$&#123;desc_major&#125;</span>次要动作名称是：按下"</span></span><br><span class="line">               <span class="comment">// 次要点松开</span></span><br><span class="line">               MotionEvent.ACTION_POINTER_UP -&gt; desc_minor = <span class="string">"<span class="subst">$&#123;desc_major&#125;</span>次要动作名称是：提起"</span></span><br><span class="line">           &#125;</span><br><span class="line">           desc_major = <span class="string">"<span class="subst">$&#123;desc_major&#125;</span>\n主要动作发生位置是：横坐标<span class="subst">$&#123;x&#125;</span>,纵坐标<span class="subst">$&#123;y&#125;</span>"</span></span><br><span class="line">       &#125;</span><br><span class="line">        mBinding.tvTouchMajor.text = desc_major</span><br><span class="line">        <span class="comment">// 存在次要点触摸</span></span><br><span class="line">        <span class="keyword">if</span> (isMinorDown || !TextUtils.isEmpty(desc_minor))&#123;</span><br><span class="line">            desc_minor = <span class="string">"<span class="subst">$&#123;desc_minor&#125;</span>\n次要动作发生位置是：横坐标<span class="subst">$&#123;event?.getX(<span class="number">1</span>)&#125;</span>，纵坐标<span class="subst">$&#123;event?.getY(<span class="number">1</span>)&#125;</span>"</span></span><br><span class="line">            mBinding.tvTouchMinor.text = desc_minor</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/7.png" alt></p>
<h3 id="3-跟踪滑动轨迹实现手写签名"><a href="#3-跟踪滑动轨迹实现手写签名" class="headerlink" title="3.跟踪滑动轨迹实现手写签名"></a>3.跟踪滑动轨迹实现手写签名</h3><p>​        实现手写签名需要结合绘图的路径工具Path，具体的实现步骤说明如下：</p>
<ol>
<li>按下手指时，调用Path对象的moveTo方法，将路径起点移到触摸点。</li>
<li>移动手指时，调用Path对象的quadTo方法，记录本次触摸点与上次触摸点之间的路径。</li>
<li>移动手指或者手指提起时，调用Canvas对象的drawPath方法，将本次触摸轨迹绘制在画布上。</li>
</ol>
<p>自定义手写签名控件的示例代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/6</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：自定义手写签名控件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SignatureView</span></span>(context: Context,attrs:AttributeSet?):View(context, attrs) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = <span class="string">"SignatureView"</span></span><br><span class="line">    <span class="comment">// 声明一个画笔对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mPathPaint = Paint()</span><br><span class="line">    <span class="comment">// 声明一个路径对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mPath = Path()</span><br><span class="line">    <span class="comment">// 画笔颜色</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mPathPaintColor = Color.BLACK</span><br><span class="line">    <span class="comment">// 画笔线宽</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mStrokeWidth = <span class="number">3f</span></span><br><span class="line">    <span class="comment">// 路径位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mPathPos = PathPosition()</span><br><span class="line">    <span class="comment">// 路径位置列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span>  mPathList = ArrayList&lt;PathPosition&gt;()</span><br><span class="line">    <span class="comment">// 上次触摸点的横纵坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mLastPos:PointF? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (attrs != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 根据SignatureView的属性定义，从布局文件中获取属性数组描述</span></span><br><span class="line">            <span class="keyword">val</span> attrArray = getContext().obtainStyledAttributes(attrs,R.styleable.SignatureView)</span><br><span class="line">            <span class="comment">// 根据属性描述定义，获取布局文件中的画笔颜色</span></span><br><span class="line">            mPathPaintColor = attrArray.getColor(R.styleable.SignatureView_paint_color,Color.BLACK)</span><br><span class="line">            <span class="comment">// 根据属性描述定义，获取布局文件中的画笔线宽</span></span><br><span class="line">            mStrokeWidth = attrArray.getInt(R.styleable.SignatureView_stroke_width,<span class="number">3</span>).toFloat()</span><br><span class="line">            <span class="comment">// 回收属性数组描述</span></span><br><span class="line">            attrArray.recycle()</span><br><span class="line">        &#125;</span><br><span class="line">        initView()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 设置画笔的线宽</span></span><br><span class="line">        mPathPaint.strokeWidth = mStrokeWidth</span><br><span class="line">        <span class="comment">// 设置画笔的类型。STROK表示空心，FILL表示实心</span></span><br><span class="line">        mPathPaint.style = Paint.Style.STROKE</span><br><span class="line">        <span class="comment">// 设置画笔的颜色</span></span><br><span class="line">        mPathPaint.color = mPathPaintColor</span><br><span class="line">        <span class="comment">// 开启当前视图的绘图缓存</span></span><br><span class="line">        isDrawingCacheEnabled = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空画布</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 重置路径对象</span></span><br><span class="line">        mPath.reset()</span><br><span class="line">        <span class="comment">// 清空路径列表</span></span><br><span class="line">        mPathList.clear()</span><br><span class="line">        <span class="comment">// 立即刷新视图（线程安全方式）</span></span><br><span class="line">        postInvalidate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 撤销上一次绘制</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">revoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mPathList.size &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// 移除路径位置列表中的最后一个路径</span></span><br><span class="line">            mPathList.removeAt(mPathList.size - <span class="number">1</span>)</span><br><span class="line">            <span class="comment">// 重置路径对象</span></span><br><span class="line">            mPath.reset()</span><br><span class="line">            <span class="keyword">for</span> (i <span class="keyword">in</span> mPathList.indices) &#123;</span><br><span class="line">                <span class="keyword">val</span> pp = mPathList.<span class="keyword">get</span>(i)</span><br><span class="line">                <span class="comment">// 移动到上一个坐标点</span></span><br><span class="line">                mPath.moveTo(pp.prePos.x,pp.prePos.y)</span><br><span class="line">                <span class="comment">// 连接上一个坐标点和下一个坐标点</span></span><br><span class="line">                mPath.quadTo(pp.prePos.x,pp.prePos.y,pp.nextPos.x,pp.nextPos.y)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 立即刷新视图（线程安全方式）</span></span><br><span class="line">            postInvalidate()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 在画布上绘制指定路径线条</span></span><br><span class="line">        canvas?.drawPath(mPath,mPathPaint)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在发生触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">when</span>(event?.action)&#123;</span><br><span class="line">            <span class="comment">// 按下手指</span></span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                <span class="comment">// 移动到指定坐标点</span></span><br><span class="line">                mPath.moveTo(event.x,event.y)</span><br><span class="line">                mPathPos.prePos = PointF(event.x,event.y)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 移动手指</span></span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                <span class="comment">// 连接上一个坐标点和当前坐标点</span></span><br><span class="line">                mLastPos?.apply &#123;</span><br><span class="line">                    mPath.quadTo(x,y,event.x,event.y)</span><br><span class="line">                &#125;</span><br><span class="line">                mPathPos.nextPos = PointF(event.x,event.y)</span><br><span class="line">                <span class="comment">// 往路径位置列表添加路径位置</span></span><br><span class="line">                mPathList.add(mPathPos)</span><br><span class="line">                <span class="comment">// 创建新的路径位置</span></span><br><span class="line">                mPathPos = PathPosition()</span><br><span class="line">                mPathPos.prePos = PointF(event.x,event.y)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 松开手指</span></span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;</span><br><span class="line">                <span class="comment">// 连接上一个坐标点和当前坐标点</span></span><br><span class="line">                mPath.quadTo(mLastPos!!.x,mLastPos!!.y,event.x,event.y)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mLastPos = PointF(event!!.x,event.y)</span><br><span class="line">        <span class="comment">// 立即刷新视图（线程安全方式）</span></span><br><span class="line">        postInvalidate()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PathPosition.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个路径位置实体类，包括上个落点的横纵坐标，以及下个落点的横纵坐标</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathPosition</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> PointF prePos; <span class="comment">// 上个落点的横纵坐标</span></span><br><span class="line">    <span class="keyword">public</span> PointF nextPos; <span class="comment">// 下个落点的横纵坐标</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>activity:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SignatureActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivitySignatureBinding</span>&gt;</span>(),View.OnClickListener &#123;</span><br><span class="line">    <span class="comment">// 签名图片的文件路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mImagePath = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivitySignatureBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mBinding.btnBeginSignature.setOnClickListener(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>)</span><br><span class="line">        mBinding.btnEndSignature.setOnClickListener(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>)</span><br><span class="line">        mBinding.btnResetSignature.setOnClickListener(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>)</span><br><span class="line">        mBinding.btnRevokeSignature.setOnClickListener(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>)</span><br><span class="line">        mBinding.btnSaveSignature.setOnClickListener(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(v: <span class="type">View</span>?)</span></span> &#123;</span><br><span class="line">        mBinding.apply &#123;</span><br><span class="line">            <span class="keyword">when</span>(v?.id)&#123;</span><br><span class="line">                btnSaveSignature.id -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (TextUtils.isEmpty(mImagePath))&#123;</span><br><span class="line">                        Toast.makeText(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>,<span class="string">"请先开始然后结束签名"</span>,Toast.LENGTH_SHORT).show()</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 通知相册来了张新图片</span></span><br><span class="line">                    BitmapUtil.notifyPhotoAlbum(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>,mImagePath)</span><br><span class="line">                &#125;</span><br><span class="line">                btnBeginSignature.id -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 开启签名视图的绘图缓存</span></span><br><span class="line">                    viewSignature.isDrawingCacheEnabled = <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">                btnResetSignature.id -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 点击了重置按钮</span></span><br><span class="line">                    <span class="comment">// 清空签名视图</span></span><br><span class="line">                    viewSignature.clear()</span><br><span class="line">                &#125;</span><br><span class="line">                btnRevokeSignature.id -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 回退签名视图的最近一笔绘画</span></span><br><span class="line">                    viewSignature.revoke()</span><br><span class="line">                &#125;</span><br><span class="line">                btnEndSignature.id -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 签名视图的绘图缓存不可用</span></span><br><span class="line">                    <span class="keyword">if</span> (!viewSignature.isDrawingCacheEnabled)&#123;</span><br><span class="line">                        <span class="comment">// 签名视图的绘图缓存不可用</span></span><br><span class="line">                        Toast.makeText(<span class="keyword">this</span><span class="symbol">@SignatureActivity</span>, <span class="string">"请先开始签名"</span>, Toast.LENGTH_LONG).show()</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 签名视图的绘图缓存当前可用</span></span><br><span class="line">                        <span class="comment">// 从绘图缓存获取位图对象</span></span><br><span class="line">                        <span class="keyword">val</span> bitmap = viewSignature.drawingCache</span><br><span class="line">                        <span class="comment">// 生成图片文件的保存路径</span></span><br><span class="line">                        mImagePath = <span class="string">"<span class="subst">$&#123;getExternalFilesDir(Environment.DIRECTORY_DOWNLOADS)&#125;</span>/<span class="subst">$&#123;DateUtil.getNowTime()&#125;</span>.jpg"</span></span><br><span class="line">                        <span class="comment">// 把位图保存为图片文件</span></span><br><span class="line">                        BitmapUtil.saveImage(mImagePath,bitmap)</span><br><span class="line">                        <span class="comment">// 设置图像视图的路径对象</span></span><br><span class="line">                        ivSignatureNew.setImageURI(Uri.parse(mImagePath))</span><br><span class="line">                        <span class="comment">// 延迟100毫秒后启动绘图缓存的重置任务</span></span><br><span class="line">                        Handler(Looper.myLooper()!!).postDelayed(&#123;</span><br><span class="line">                            <span class="comment">// 关闭签名视图的绘图缓存</span></span><br><span class="line">                            viewSignature.isDrawingCacheEnabled = <span class="literal">false</span></span><br><span class="line">                            <span class="comment">// 开启签名视图的绘图缓存</span></span><br><span class="line">                            viewSignature.isDrawingCacheEnabled = <span class="literal">true</span></span><br><span class="line">                        &#125;,<span class="number">100</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/8.png" alt></p>
<h2 id="根据触摸行为辨别手势动作"><a href="#根据触摸行为辨别手势动作" class="headerlink" title="根据触摸行为辨别手势动作"></a>根据触摸行为辨别手势动作</h2><h3 id="1-区分点击和长按动作"><a href="#1-区分点击和长按动作" class="headerlink" title="1.区分点击和长按动作"></a>1.区分点击和长按动作</h3><p>​        区分点击和长按动作，只要看按压时长是否超过500毫秒即可，没超过的表示点击动作，超过了的表示长按动作。其实，除了按压时长之外，按压力度也是一个重要的参考指标。通常，点击时按得比较轻，长按时按得相对重。依据按压时长与按压力度两项指标即可有效地辨别点击和长按动作。</p>
<p>​        接下来尝试自定义点击视图，且以按压点为圆心绘制圆圈，从而分别观察点击与长按之时的圆圈大小。定义点击视图的示例代码如下：</p>
<p>ClickView.kt:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/6</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：以按压点为圆心绘制圆圈</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClickView</span></span>(context:Context,attrs:AttributeSet?) :View(context, attrs) &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mPaint = Paint()</span><br><span class="line">    <span class="comment">// 上次按下手指的系统时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mLastTime = <span class="number">0L</span></span><br><span class="line">    <span class="comment">// 按下手指的坐标点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mPos:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 按压的压力值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mPressure = <span class="number">0F</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> dip_10 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mListener:LiftListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        dip_10 = Utils.dip2px(context,<span class="number">10f</span>)</span><br><span class="line">        mPaint.color = Color.DKGRAY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">       mPos?.apply &#123;</span><br><span class="line">           <span class="comment">// 以按压点为圆心，压力值为半径，在画布上绘制实心圆</span></span><br><span class="line">           canvas?.drawCircle(x,y,dip_10*mPressure,mPaint)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在发生触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event?.action == MotionEvent.ACTION_DOWN</span><br><span class="line">            || (event!!.pressure &gt; mPressure))&#123;</span><br><span class="line">            mPos = PointF(event.x,event.y)</span><br><span class="line">            <span class="comment">// 获取本次触摸过程的最大压力值</span></span><br><span class="line">            mPressure = event.pressure</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">when</span>(event.action)&#123;</span><br><span class="line">            <span class="comment">// 按下手指</span></span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                mLastTime = event.eventTime</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 移动手指</span></span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;&#125;</span><br><span class="line">            <span class="comment">// 松开手指</span></span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;</span><br><span class="line">                mListener?.let &#123;</span><br><span class="line">                    it.onLift(event.eventTime - mLastTime,mPressure)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 立即刷新视图（线程安全方式）</span></span><br><span class="line">        postInvalidate()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明一个手势抬起监听器</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">LiftListener</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onLift</span><span class="params">(time_interval: <span class="type">Long</span>,pressure:<span class="type">Float</span>)</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setLiftListener</span><span class="params">(listener: <span class="type">LiftListener</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mListener = listener</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Activity.kt:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClickLongActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityClickLongBinding</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityClickLongBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">//手势抬起监听 回调</span></span><br><span class="line">        cvGesture.setLiftListener(<span class="keyword">object</span> : ClickView.LiftListener&#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLift</span><span class="params">(time_interval: <span class="type">Long</span>, pressure: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">               <span class="keyword">val</span> gesture = <span class="keyword">if</span> (time_interval &gt; <span class="number">500</span>) <span class="string">"长按"</span> <span class="keyword">else</span> <span class="string">"点击"</span></span><br><span class="line">               <span class="keyword">val</span> desc = <span class="string">"本次按压时长为<span class="subst">$&#123;time_interval&#125;</span>毫秒，属于<span class="subst">$&#123;gesture&#125;</span>动作。\n按压的压力峰值为<span class="subst">$&#123;pressure&#125;</span>"</span></span><br><span class="line">               tvDesc.text = desc</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/9.png" alt></p>
<h3 id="2-识别手势滑动的方向"><a href="#2-识别手势滑动的方向" class="headerlink" title="2.识别手势滑动的方向"></a>2.识别手势滑动的方向</h3><p>​        手势在水平方向掠过，意味着左右滑动；手势在垂直方向掠过，意味着上下滚动。左右滑动的话，手势触摸的起点和终点在水平方向的位移必定大于垂直方向的位移；反之，上下滚动的话，它们在垂直方向的位移必定大于水平方向的位移。据此<strong>可将滑动方向的判定过程分解成以下三个步骤</strong>：</p>
<ol>
<li>对于按下手指事件，把当前点标记为起点，并记录起点的横纵坐标。</li>
<li>对于松开手指事件，把当前点标记为终点，并记录终点的横纵坐标。</li>
<li>分别计算起点与终点的横坐标距离以及它们的纵坐标距离，根据横纵坐标的大小关系判断本次手势的滑动方向。</li>
</ol>
<p>​       于是重写自定义触摸视图的onTouchEvent方法，分别处理按下、移动、松开三种手势事件；同时重写该视图的onDraw方法，描绘起点与终点的位置，以及从起点到终点的路径线条。按照上述思路，编写单指触摸视图的代码：</p>
<p>SingleTouchView.kt:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：描绘起点与终点的位置，以及从起点到终点的路径线条</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleTouchView</span></span>(context:Context,attrs:AttributeSet?):View(context, attrs) &#123;</span><br><span class="line">    <span class="comment">// 路径的画笔，以及起点和终点的画笔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mPathPaint:Paint</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mBeginPaint:Paint</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mEndPaint:Paint</span><br><span class="line">    <span class="comment">// 声明一个路径对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mPath = Path()</span><br><span class="line">    <span class="comment">// 路径中的上次触摸点，本次按压的起点和终点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mLastPos:PointF</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mBeginPos:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mEndPos:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> dip_17:<span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mListener:FlipListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        dip_17 = Utils.dip2px(context,<span class="number">17F</span>)</span><br><span class="line">        initView()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化视图</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 创建路径的画笔</span></span><br><span class="line">        mPathPaint = Paint()</span><br><span class="line">        mPathPaint.strokeWidth = <span class="number">5f</span></span><br><span class="line">        mPathPaint.style = Paint.Style.STROKE</span><br><span class="line">        mPathPaint.color = Color.BLACK</span><br><span class="line">        <span class="comment">//创建起点画笔</span></span><br><span class="line">        mBeginPaint = Paint()</span><br><span class="line">        mBeginPaint.color = Color.RED</span><br><span class="line">        mBeginPaint.textSize = dip_17.toFloat()</span><br><span class="line">        <span class="comment">//创建终点画笔</span></span><br><span class="line">        mEndPaint = Paint()</span><br><span class="line">        mEndPaint.color = Color.DKGRAY</span><br><span class="line">        mEndPaint.textSize = dip_17.toFloat()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个手势飞掠的监听器接口</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">FlipListener</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onFlipFinish</span><span class="params">(beginPos:<span class="type">PointF</span>,endPos:<span class="type">PointF</span>)</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">        canvas?.apply &#123;</span><br><span class="line">            <span class="comment">// 在画布上绘制指定路径线条</span></span><br><span class="line">            drawPath(mPath,mPathPaint)</span><br><span class="line">            <span class="keyword">if</span> (mBeginPos != <span class="literal">null</span>)&#123;</span><br><span class="line">                drawCircle(mBeginPos!!.x,mBeginPos!!.y,<span class="number">10f</span>,mBeginPaint)</span><br><span class="line">                drawText(<span class="string">"起点"</span>,mBeginPos!!.x-dip_17,mBeginPos!!.y + dip_17,mBeginPaint)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mEndPos != <span class="literal">null</span>)&#123;</span><br><span class="line">                drawCircle(mEndPos!!.x,mEndPos!!.y,<span class="number">10f</span>,mEndPaint)</span><br><span class="line">                drawText(<span class="string">"终点"</span>,mEndPos!!.x-dip_17,mEndPos!!.y + dip_17,mEndPaint)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">when</span>(event?.action)&#123;</span><br><span class="line">            <span class="comment">//按下手指</span></span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                mPath.reset()</span><br><span class="line">                <span class="comment">//移动到指定点坐标</span></span><br><span class="line">                mPath.moveTo(event.x,event.y)</span><br><span class="line">                mBeginPos = PointF(event.x,event.y)</span><br><span class="line">                mEndPos = <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//移动手指</span></span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                <span class="comment">// 连接上一个坐标点和当前坐标点</span></span><br><span class="line">                mPath.quadTo(mLastPos.x,mLastPos.y,event.x,event.y)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//松开手指</span></span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;</span><br><span class="line">                mEndPos = PointF(event.x,event.y)</span><br><span class="line">                <span class="comment">// 连接上一个坐标点和当前坐标点</span></span><br><span class="line">                mPath.quadTo(mLastPos.x,mLastPos.y,event.x,event.y)</span><br><span class="line">                mListener?.onFlipFinish(mBeginPos!!,mEndPos!!)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mLastPos = PointF(event!!.x,event.y)</span><br><span class="line">        <span class="comment">// 立即刷新视图（线程安全方式）</span></span><br><span class="line">        postInvalidate()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setFlipListener</span><span class="params">(listener:<span class="type">FlipListener</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mListener = listener</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Activity.kt</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SlideDirectionActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivitySlideDirectionBinding</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = <span class="string">"SlideDirectionActivity"</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivitySlideDirectionBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 设置单点触摸视图的手势飞掠监听器</span></span><br><span class="line">        stvGesture.setFlipListener(<span class="keyword">object</span> :SingleTouchView.FlipListener&#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFlipFinish</span><span class="params">(beginPos: <span class="type">PointF</span>, endPos: <span class="type">PointF</span>)</span></span> &#123;</span><br><span class="line">                <span class="keyword">val</span> offsetX = abs(endPos.x - beginPos.x)</span><br><span class="line">                <span class="keyword">val</span> offsetY = abs(endPos.y - beginPos.y)</span><br><span class="line">                <span class="keyword">var</span> gesture = <span class="string">""</span></span><br><span class="line">                gesture = <span class="keyword">when</span>&#123;</span><br><span class="line">                    <span class="comment">//水平方向滑动</span></span><br><span class="line">                    offsetX &gt; offsetY -&gt; <span class="keyword">if</span>(endPos.x - beginPos.x &gt; <span class="number">0</span>) <span class="string">"向右"</span> <span class="keyword">else</span> <span class="string">"向左"</span></span><br><span class="line">                    <span class="comment">//垂直方向滑动</span></span><br><span class="line">                    offsetX &lt; offsetY -&gt; <span class="keyword">if</span>(endPos.y - beginPos.y &gt; <span class="number">0</span>) <span class="string">"向下"</span> <span class="keyword">else</span> <span class="string">"向上"</span></span><br><span class="line">                    <span class="comment">//视图对角线</span></span><br><span class="line">                    <span class="keyword">else</span> -&gt; <span class="string">"对角线"</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> desc = <span class="string">"<span class="subst">$&#123;DateUtil.getNowTime()&#125;</span> 本次手势为<span class="subst">$&#123;gesture&#125;</span>滑动"</span></span><br><span class="line">                tvDesc.text = desc</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/10.png" alt></p>
<h3 id="3-辨别缩放与旋转手势"><a href="#3-辨别缩放与旋转手势" class="headerlink" title="3.辨别缩放与旋转手势"></a>3.辨别缩放与旋转手势</h3><p>​        由于两个手指各有自己的按下与松开事件，都有对应的触摸起点和终点，因此只要依次记录两个手指的起点和终点坐标，根据这四个点的位置关系就能算出手势的动作类别。</p>
<p>​        缩放手势与旋转手势的区分，则需分别计算第一个手势起点和终点的连线，以及第二个手势起点和终点的连线，再判断两根连线是倾向于在相同方向上缩放还是倾向于绕着连线中点旋转。</p>
<p>双指触摸视图的关键代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：双指触摸视图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiTouchView</span></span>(context: Context,attrs:AttributeSet?):View(context, attrs) &#123;</span><br><span class="line">    <span class="comment">// 路径的画笔、虚线的画笔，以及起点和终点的画笔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mPathPaint:Paint</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mBeginPaint:Paint</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mEndPaint:Paint</span><br><span class="line">    <span class="comment">// 声明主要动作的路径对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mFirstPath = Path()</span><br><span class="line">    <span class="comment">// 声明次要动作的路径对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mSecondPath = Path()</span><br><span class="line">    <span class="comment">// 主要动作的上次触摸点，本次按压的起点和终点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mFirstLastP:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mFirstBeginP:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mFirstEndP:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 次要动作的上次触摸点，本次按压的起点和终点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mSecondLastP:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mSecondBeginP:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mSecondEndP:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 是否结束触摸</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isFinish = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> dip_10 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> dip_5 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mListener:SlideListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        dip_10 = Utils.dip2px(context,<span class="number">10f</span>)</span><br><span class="line">        dip_5 = Utils.dip2px(context,<span class="number">5f</span>)</span><br><span class="line">        initView()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 创建路径的画笔</span></span><br><span class="line">        mPathPaint = Paint()</span><br><span class="line">        <span class="comment">// 设置画笔的线宽</span></span><br><span class="line">        mPathPaint.strokeWidth = <span class="number">5f</span></span><br><span class="line">        <span class="comment">// 设置画笔的类型。STROK表示空心，FILL表示实心</span></span><br><span class="line">        mPathPaint.style = Paint.Style.STROKE</span><br><span class="line">        <span class="comment">// 设置画笔的颜色</span></span><br><span class="line">        mPathPaint.color = Color.BLACK</span><br><span class="line">        <span class="keyword">val</span> thinDash = DashPathEffect(floatArrayOf(dip_10.toFloat(), dip_5.toFloat()), <span class="number">1F</span>)</span><br><span class="line"></span><br><span class="line">        mBeginPaint = Paint()</span><br><span class="line">        mBeginPaint.strokeWidth = <span class="number">3f</span></span><br><span class="line">        mBeginPaint.style = Paint.Style.STROKE</span><br><span class="line">        mBeginPaint.color = Color.RED</span><br><span class="line">        <span class="comment">// 设置虚线的样式</span></span><br><span class="line">        mBeginPaint.pathEffect = thinDash</span><br><span class="line">        <span class="keyword">val</span> denseDash = DashPathEffect(floatArrayOf(dip_10.toFloat(), dip_5.toFloat()), <span class="number">1F</span>)</span><br><span class="line"></span><br><span class="line">        mEndPaint = Paint()</span><br><span class="line">        mEndPaint.strokeWidth = <span class="number">3F</span></span><br><span class="line">        mEndPaint.style = Paint.Style.STROKE</span><br><span class="line">        mEndPaint.color = Color.GREEN</span><br><span class="line">        mEndPaint.pathEffect = denseDash</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDraw</span><span class="params">(canvas: <span class="type">Canvas</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 在画布上绘制指定路径线条</span></span><br><span class="line">        canvas?.drawPath(mFirstPath,mPathPaint)</span><br><span class="line">        <span class="comment">// 在画布上绘制指定路径线条</span></span><br><span class="line">        canvas?.drawPath(mSecondPath,mPathPaint)</span><br><span class="line">        <span class="comment">// 结束触摸，则绘制两个起点的连线，以及两个终点的连线</span></span><br><span class="line">        <span class="keyword">if</span> (isFinish) &#123;</span><br><span class="line">            <span class="comment">// 绘制两个起点的连线</span></span><br><span class="line">            <span class="keyword">if</span> (mFirstBeginP != <span class="literal">null</span> &amp;&amp; mSecondBeginP != <span class="literal">null</span>)&#123;</span><br><span class="line">                canvas?.drawLine(mFirstBeginP!!.x,mFirstBeginP!!.y,mSecondBeginP!!.x,mSecondBeginP!!.y,mBeginPaint)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mFirstEndP != <span class="literal">null</span> &amp;&amp; mSecondEndP != <span class="literal">null</span>)&#123;</span><br><span class="line">                canvas?.drawLine(mFirstEndP!!.x,mFirstEndP!!.y,mSecondEndP!!.x,mSecondEndP!!.y,mEndPaint)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> firstP = PointF(event!!.x,event.y)</span><br><span class="line">        <span class="keyword">var</span> secondP: PointF? = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">if</span> (event.pointerCount &gt;= <span class="number">2</span>)&#123;</span><br><span class="line">            secondP = PointF(event.getX(<span class="number">1</span>),event.getY(<span class="number">1</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获得包括次要点在内的触摸行为</span></span><br><span class="line">        <span class="keyword">val</span> action = event.action and(MotionEvent.ACTION_MASK)</span><br><span class="line">        <span class="keyword">when</span>(action)&#123;</span><br><span class="line">            <span class="comment">// 主要点按下</span></span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                isFinish = <span class="literal">false</span></span><br><span class="line">                mFirstPath.reset()</span><br><span class="line">                mSecondPath.reset()</span><br><span class="line">                <span class="comment">// 移动到指定坐标点</span></span><br><span class="line">                mFirstPath.moveTo(firstP.x,firstP.y)</span><br><span class="line">                mFirstBeginP = PointF(firstP.x,firstP.y)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 移动手指</span></span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!isFinish)&#123;</span><br><span class="line">                    <span class="comment">// 连接上一个坐标点和当前坐标点</span></span><br><span class="line">                    mFirstPath.quadTo(mFirstLastP!!.x,mFirstLastP!!.y,firstP.x,firstP.y)</span><br><span class="line">                    <span class="keyword">if</span> (secondP != <span class="literal">null</span>)&#123;</span><br><span class="line">                        <span class="comment">// 连接上一个坐标点和当前坐标点</span></span><br><span class="line">                        mSecondPath.quadTo(mSecondLastP!!.x,mSecondLastP!!.y,secondP.x,secondP.y)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 主要点松开</span></span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;&#125;</span><br><span class="line">            <span class="comment">// 次要点按下</span></span><br><span class="line">            MotionEvent.ACTION_POINTER_DOWN -&gt; &#123;</span><br><span class="line">                <span class="comment">// 移动到指定坐标点</span></span><br><span class="line">                mSecondPath.moveTo(secondP!!.x,secondP.y)</span><br><span class="line">                mSecondBeginP = PointF(secondP.x,secondP.y)</span><br><span class="line">                mSecondEndP = <span class="literal">null</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 次要点松开</span></span><br><span class="line">            MotionEvent.ACTION_POINTER_UP -&gt; &#123;</span><br><span class="line">                isFinish = <span class="literal">true</span></span><br><span class="line">                mFirstEndP = PointF(firstP.x,firstP.y)</span><br><span class="line">                mSecondEndP = PointF(secondP!!.x,secondP.y)</span><br><span class="line">                mListener?.onSlideFinish(mFirstBeginP!!,mFirstEndP!!,mSecondBeginP!!,mSecondEndP!!)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mFirstLastP = PointF(firstP.x,firstP.y)</span><br><span class="line">        <span class="keyword">if</span> (secondP != <span class="literal">null</span>)&#123;</span><br><span class="line">            mSecondLastP = PointF(secondP.x,secondP.y)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 立即刷新视图（线程安全方式）</span></span><br><span class="line">        postInvalidate()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setSlideListener</span><span class="params">(slideListener: <span class="type">SlideListener</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mListener = slideListener</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">SlideListener</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onSlideFinish</span><span class="params">(firstBeginP:<span class="type">PointF</span>,firstEndP:<span class="type">PointF</span>,secondBeginP:<span class="type">PointF</span>,secondEndP:<span class="type">PointF</span>)</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Activity:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScaleRotateActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityScaleRotateBinding</span>&gt;</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityScaleRotateBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 设置多点触摸视图的手势滑动监听器</span></span><br><span class="line">        mtvGesture.setSlideListener(<span class="keyword">object</span> :MultiTouchView.SlideListener&#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSlideFinish</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                firstBeginP: <span class="type">PointF</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                firstEndP: <span class="type">PointF</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                secondBeginP: <span class="type">PointF</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                secondEndP: <span class="type">PointF</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="comment">// 上次两个触摸点之间的距离</span></span><br><span class="line">                <span class="keyword">val</span> preWholeDistance = PointUtil.distance(firstBeginP,secondBeginP)</span><br><span class="line">                <span class="comment">// 当前两个触摸点之间的距离</span></span><br><span class="line">                <span class="keyword">val</span> nowWholeDistance = PointUtil.distance(firstEndP,secondEndP)</span><br><span class="line">                <span class="comment">// 主要点在前后两次落点之间的距离</span></span><br><span class="line">                <span class="keyword">val</span> primaryDistance = PointUtil.distance(firstBeginP,firstEndP)</span><br><span class="line">                <span class="comment">// 次要点在前后两次落点之间的距离</span></span><br><span class="line">                <span class="keyword">val</span> secondaryDistance = PointUtil.distance(secondBeginP,secondEndP)</span><br><span class="line">                <span class="keyword">if</span> (abs(nowWholeDistance - preWholeDistance) &gt; Math.sqrt(<span class="number">2.0</span>)/<span class="number">2f</span> * (primaryDistance + secondaryDistance))&#123;</span><br><span class="line">                    <span class="comment">// 倾向于在原始线段的相同方向上移动，则判作缩放动作</span></span><br><span class="line">                    <span class="keyword">val</span> scaleRatio = nowWholeDistance / preWholeDistance</span><br><span class="line">                    <span class="keyword">val</span> desc = <span class="string">"本次手势为缩放动作，<span class="subst">$&#123;if (scaleRatio&gt;=<span class="number">1</span>) <span class="string">"放大倍数"</span> else <span class="string">"缩小比例"</span>&#125;</span>为<span class="subst">$&#123;scaleRatio&#125;</span>"</span></span><br><span class="line">                    tvDesc.text = desc</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">// 倾向于在原始线段的垂直方向上移动，则判作旋转动作</span></span><br><span class="line">                    <span class="comment">// 计算上次触摸事件的旋转角度</span></span><br><span class="line">                    <span class="keyword">val</span> preDegree = PointUtil.degree(firstBeginP,secondBeginP)</span><br><span class="line">                    <span class="comment">// 计算本次触摸事件的旋转角度</span></span><br><span class="line">                    <span class="keyword">val</span> nowDegree = PointUtil.degree(firstEndP,secondEndP)</span><br><span class="line">                    <span class="keyword">val</span> desc = <span class="string">"本次手势为旋转动作，<span class="subst">$&#123;if (nowDegree&gt;preDegree) <span class="string">"顺时针"</span> else <span class="string">"逆时针"</span>&#125;</span>方向旋转了<span class="subst">$&#123;abs(nowDegree-preDegree)&#125;</span>度"</span></span><br><span class="line">                    tvDesc.text = desc</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/11.png" alt></p>
<h2 id="手势冲突处理"><a href="#手势冲突处理" class="headerlink" title="手势冲突处理"></a>手势冲突处理</h2><ol>
<li><p><strong>上下滚动与左右滑动的冲突</strong></p>
<p>既可由父视图主动判断是否拦截，又可由子视图根据情况向父反馈是否允许拦截；</p>
</li>
<li><p><strong>内部滑动与翻页滑动的冲突</strong></p>
<p>可以通过限定在某块区域接管特定的手势来实现对不同手势的区分处理；</p>
</li>
<li><p><strong>正常下拉与下拉刷新的冲突</strong></p>
<p>需要监控当前是否已经下拉到页面顶部，若未拉到页面顶部则为正常下拉，若已拉到页面顶部则为下拉刷新。</p>
</li>
</ol>
<h3 id="1-上下滚动与左右滑动的冲突处理"><a href="#1-上下滚动与左右滑动的冲突处理" class="headerlink" title="1.上下滚动与左右滑动的冲突处理"></a>1.上下滚动与左右滑动的冲突处理</h3><p>​        Android控件繁多，允许滚动或滑动操作的视图也不少，例如滚动视图、翻页视图等，如果开发者要自己接管手势处理，比如通过手势控制横幅（Banner）轮播，那么这个页面的滑动就存在冲突的情况，如果系统响应了A视图的滑动事件，就顾不上B视图的滑动事件。</p>
<p>​        要解决这个滑动冲突，关键在于提供某种方式通知滚动视图，告诉它什么时候可以上下滚动、什么时候不能上下滚动。</p>
<p>这个通知方式主要有两种：</p>
<ul>
<li>一种是父视图主动向下“查询”，即由滚动视图判断滚动规则并决定是否拦截手势；</li>
<li>另一种是子视图向上“反映”，即由子视图告诉滚动视图是否拦截手势。</li>
</ul>
<p><strong>1. 由滚动视图判断滚动规则</strong></p>
<p>​        前面提到，容器类视图可以重写<strong>onInterceptTouchEvent</strong>方法，根据条件判断结果决定是否拦截发给子视图的手势。那么可以自定义一个滚动视图，在<strong>onInterceptTouchEvent</strong>方法中判断本次手势的横坐标与纵坐标，如果纵坐标的偏移大于横坐标的偏移，此时就是垂直滚动，应拦截手势并交给自身进行上下滚动；否则表示此时为水平滚动，不应拦截手势，而是让子视图处理左右滑动事件。</p>
<p>CustomScrollView.kt:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/8</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：自定义滚动视图拦截垂直滚动并放过水平滚动</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomScrollView</span></span>(context : Context,attrs:AttributeSet?) :ScrollView(context, attrs) &#123;</span><br><span class="line">    <span class="comment">// 横纵方向上的偏移</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mOffsetX = <span class="number">0F</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mOffsetY = <span class="number">0F</span></span><br><span class="line">    <span class="comment">// 上次落点的位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mLastPos:PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 与边缘线的间距阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mInterval:<span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在拦截触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        Log.d(<span class="string">"CustomScrollView"</span>,<span class="string">"触摸事件拦截"</span>)</span><br><span class="line">        <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> (ev?.action == MotionEvent.ACTION_DOWN)&#123;</span><br><span class="line">            Log.d(<span class="string">"CustomScrollView"</span>,<span class="string">"按下"</span>)</span><br><span class="line">            mLastPos = PointF(ev.x,ev.y)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(ev)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">// 其余动作，包括手指移动、手指松开等等</span></span><br><span class="line">            Log.d(<span class="string">"CustomScrollView"</span>,<span class="string">"其他"</span>)</span><br><span class="line">            <span class="keyword">val</span> thisPos = PointF(ev!!.x,ev.y)</span><br><span class="line">            <span class="comment">//x轴偏差</span></span><br><span class="line">            mOffsetX += Math.abs(thisPos.x - mLastPos!!.x)</span><br><span class="line">            <span class="comment">//y轴偏差</span></span><br><span class="line">            mOffsetY += Math.abs(thisPos.y - mLastPos!!.y)</span><br><span class="line">            mLastPos = thisPos</span><br><span class="line">            result = <span class="keyword">when</span>&#123;</span><br><span class="line">                <span class="comment">// false传给表示子控件，此时为点击事件</span></span><br><span class="line">                mOffsetX &lt; mInterval &amp;&amp; mOffsetY &lt; mInterval -&gt; &#123;</span><br><span class="line">                    Log.d(<span class="string">"CustomScrollView"</span>,<span class="string">"触摸事件拦截,此时为点击事件"</span>)</span><br><span class="line">                    <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// true表示不传给子控件，此时为垂直滑动</span></span><br><span class="line">                mOffsetX &lt; mOffsetY -&gt; &#123;</span><br><span class="line">                    Log.d(<span class="string">"CustomScrollView"</span>,<span class="string">"触摸事件拦截,此时为垂直滑动"</span>)</span><br><span class="line">                    <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// false表示传给子控件，此时为水平滑动</span></span><br><span class="line">                <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                    Log.d(<span class="string">"CustomScrollView"</span>,<span class="string">"触摸事件拦截,此时为水平滑动"</span>)</span><br><span class="line">                    <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/12.png" alt></p>
<p>​    <strong>2. 子视图告诉滚动视图能否拦截手势</strong></p>
<p>​        调用requestDisallowInterceptTouchEvent方法（输入参数为true时表示禁止上级拦截触摸事件）。至于何时调用该方法，当然是在检测到滑动前后的横坐标偏移大于纵坐标偏移时。对于横幅采用手势监听器的情况，可重写onTouchEvent方法（在该方法中加入坐标偏移的判断），示例代码如下：</p>
<p>BannerPager.kt:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        Log.d(<span class="string">"BannerPager"</span>,<span class="string">"touch"</span>)</span><br><span class="line">        <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line">        <span class="comment">// 按下手指</span></span><br><span class="line">        <span class="keyword">if</span> (event?.action == MotionEvent.ACTION_DOWN)&#123;</span><br><span class="line">            Log.d(<span class="string">"BannerPager"</span>,<span class="string">"按下"</span>)</span><br><span class="line">            mLastPos = PointF(event.x,event.y)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 其余动作，包括移动手指、松开手指等等</span></span><br><span class="line">            Log.d(<span class="string">"BannerPager"</span>,<span class="string">"其他"</span>)</span><br><span class="line">            <span class="keyword">val</span> thisPos = PointF(event!!.x,event.y)</span><br><span class="line">            <span class="comment">// x轴偏差</span></span><br><span class="line">            mOffsetX += Math.abs(thisPos.x - mLastPos!!.x)</span><br><span class="line">            <span class="comment">// y轴偏差</span></span><br><span class="line">            mOffsetY += Math.abs(thisPos.y - mLastPos!!.y)</span><br><span class="line">            mLastPos = thisPos</span><br><span class="line">            <span class="comment">// 水平方向的滚动</span></span><br><span class="line">            <span class="keyword">if</span> (mOffsetX &gt;= mOffsetY)&#123;</span><br><span class="line">                Log.d(<span class="string">"BannerPager"</span>,<span class="string">"水平方向的滚动"</span>)</span><br><span class="line">                <span class="comment">// 如果外层是普通的ScrollView，则此处不允许父容器的拦截动作</span></span><br><span class="line">                <span class="comment">// CustomScrollActivity通过自定义滚动视图来区分水平滑动还是垂直滑动</span></span><br><span class="line">                <span class="comment">// DisallowScrollActivity使用滚动视图，则此处需要下面代码禁止父容器拦截</span></span><br><span class="line">                parent.requestDisallowInterceptTouchEvent(<span class="literal">true</span>)</span><br><span class="line">                <span class="comment">// 返回true表示要继续处理</span></span><br><span class="line">                result = <span class="literal">true</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">// 垂直方向的滚动</span></span><br><span class="line">                <span class="comment">// 返回false表示不处理了</span></span><br><span class="line">                result = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>修改后左右滑动能够正常翻页，整个页面也不容易上下滚动。</p>
<h3 id="2-内部滑动与翻页滑动的冲突处理"><a href="#2-内部滑动与翻页滑动的冲突处理" class="headerlink" title="2.内部滑动与翻页滑动的冲突处理"></a>2.内部滑动与翻页滑动的冲突处理</h3><p>​        比如页面采用翻页视图的话，页面内的每个区域之间是左右滑动的关系，并且每个区域都可以拥有自己的滚动视图。如此一来，在左右滑动时，滚动视图反而变成翻页视图的子视图，前面的冲突处理办法就不能奏效了，只能另想办法。</p>
<p>​        自定义一个基于ViewPager的翻页视图是一种思路，另外还可以借鉴抽屉布局DrawerLayout。抽屉布局与翻页视图在滑动方面存在区别，翻页视图在内部的任何位置均可触发滑动事件，而抽屉布局只在屏幕两侧边缘才会触发滑动事件。</p>
<p>下面是DrawerLayout的常用方法：</p>
<ul>
<li><p>setDrawerShadow：设置首页面的渐变阴影图形。</p>
</li>
<li><p>addDrawerListener：添加抽屉面板的拉出监听器，需实现DrawerListener的如下4个方法：</p>
<ol>
<li>onDrawerSlide：抽屉面板滑动时触发。</li>
<li>onDrawerOpened：抽屉面板打开时触发。</li>
<li>onDrawerClosed：抽屉面板关闭时触发。</li>
<li>onDrawerStateChanged：抽屉面板的状态发生变化时触发。</li>
</ol>
</li>
<li><p>removeDrawerListener：移除抽屉面板的拉出监听器。</p>
</li>
<li><p>closeDrawers：关闭所有抽屉面板。</p>
</li>
<li><p>openDrawer：打开指定抽屉面板。</p>
</li>
<li><p>closeDrawer：关闭指定抽屉面板。</p>
</li>
<li><p>isDrawerOpen：判断指定抽屉面板是否打开。</p>
</li>
</ul>
<p>​       抽屉布局不仅可以拉出左侧抽屉面板，还可以拉出右侧抽屉面板。左侧面板与右侧面板的区别在于：左侧面板在布局文件中的layout_gravity属性为left，右侧面板在布局文件中的layout_gravity属性为right。</p>
<p>下面是使用DrawerLayout的布局文件：</p>
<p>drawer_layout.xml:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;androidx.drawerlayout.widget.DrawerLayout</span><br><span class="line">        android:id=<span class="string">"@+id/dl_layout"</span></span><br><span class="line">        android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">        android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">        tools:context=<span class="string">".ui.DrawerLayoutActivity"</span>&gt;</span><br><span class="line"></span><br><span class="line">        &lt;LinearLayout</span><br><span class="line">            android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">            android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">            android:orientation=<span class="string">"vertical"</span>&gt;</span><br><span class="line"></span><br><span class="line">            &lt;LinearLayout</span><br><span class="line">                android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">                android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">                android:orientation=<span class="string">"horizontal"</span>&gt;</span><br><span class="line"></span><br><span class="line">                &lt;Button</span><br><span class="line">                    android:id=<span class="string">"@+id/btn_drawer_left"</span></span><br><span class="line">                    android:layout_width=<span class="string">"0dp"</span></span><br><span class="line">                    android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">                    android:layout_weight=<span class="string">"1"</span></span><br><span class="line">                    android:gravity=<span class="string">"center"</span></span><br><span class="line">                    android:text=<span class="string">"打开左边侧滑"</span></span><br><span class="line">                    android:textColor=<span class="string">"@color/black"</span></span><br><span class="line">                    android:textSize=<span class="string">"17sp"</span> /&gt;</span><br><span class="line"></span><br><span class="line">                &lt;Button</span><br><span class="line">                    android:id=<span class="string">"@+id/btn_drawer_right"</span></span><br><span class="line">                    android:layout_width=<span class="string">"0dp"</span></span><br><span class="line">                    android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">                    android:layout_weight=<span class="string">"1"</span></span><br><span class="line">                    android:gravity=<span class="string">"center"</span></span><br><span class="line">                    android:text=<span class="string">"打开右边侧滑"</span></span><br><span class="line">                    android:textColor=<span class="string">"@color/black"</span></span><br><span class="line">                    android:textSize=<span class="string">"17sp"</span> /&gt;</span><br><span class="line">            &lt;/LinearLayout&gt;</span><br><span class="line"></span><br><span class="line">            &lt;TextView</span><br><span class="line">                android:id=<span class="string">"@+id/tv_drawer_center"</span></span><br><span class="line">                android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">                android:layout_height=<span class="string">"0dp"</span></span><br><span class="line">                android:layout_weight=<span class="string">"1"</span></span><br><span class="line">                android:gravity=<span class="string">"top|center"</span></span><br><span class="line">                android:paddingTop=<span class="string">"30dp"</span></span><br><span class="line">                android:text=<span class="string">"这里是首页"</span></span><br><span class="line">                android:textColor=<span class="string">"@color/black"</span></span><br><span class="line">                android:textSize=<span class="string">"17sp"</span> /&gt;</span><br><span class="line">        &lt;/LinearLayout&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 抽屉布局左边的侧滑列表视图，layout_gravity属性设定了它的对齐方式 --&gt;</span><br><span class="line">        &lt;ListView</span><br><span class="line">            android:id=<span class="string">"@+id/lv_drawer_left"</span></span><br><span class="line">            android:layout_width=<span class="string">"150dp"</span></span><br><span class="line">            android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">            android:layout_gravity=<span class="string">"left"</span></span><br><span class="line">            android:background=<span class="string">"#ffdd99"</span> /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 抽屉布局右边的侧滑列表视图，layout_gravity属性设定了它的对齐方式 --&gt;</span><br><span class="line">        &lt;ListView</span><br><span class="line">            android:id=<span class="string">"@+id/lv_drawer_right"</span></span><br><span class="line">            android:layout_width=<span class="string">"150dp"</span></span><br><span class="line">            android:layout_height=<span class="string">"match_parent"</span></span><br><span class="line">            android:layout_gravity=<span class="string">"right"</span></span><br><span class="line">            android:background=<span class="string">"#99ffdd"</span> /&gt;</span><br><span class="line">    &lt;/androidx.drawerlayout.widget.DrawerLayout&gt;</span><br></pre></td></tr></table></figure>

<p>activity:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawerLayoutActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityDrawerLayoutBinding</span>&gt;</span>() &#123;</span><br><span class="line">    <span class="comment">// 左侧菜单项的标题数组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> titleArr = arrayOf(<span class="string">"首页"</span>, <span class="string">"新闻"</span>, <span class="string">"娱乐"</span>, <span class="string">"博客"</span>, <span class="string">"论坛"</span>)</span><br><span class="line">    <span class="comment">// 右侧菜单项的标题数组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> settingArray = arrayOf(<span class="string">"我的"</span>, <span class="string">"设置"</span>, <span class="string">"关于"</span>)</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityDrawerLayoutBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        dlLayout.addDrawerListener(SlidingListener())</span><br><span class="line">        btnDrawerLeft.setOnClickListener &#123;</span><br><span class="line">            <span class="comment">// 左侧菜单已打开</span></span><br><span class="line">            <span class="keyword">if</span> (dlLayout.isDrawerOpen(lvDrawerLeft))&#123;</span><br><span class="line">                dlLayout.closeDrawer(lvDrawerLeft)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 左侧菜单未打开</span></span><br><span class="line">                dlLayout.openDrawer(lvDrawerLeft)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        btnDrawerRight.setOnClickListener &#123;</span><br><span class="line">            <span class="comment">// 左侧菜单已打开</span></span><br><span class="line">            <span class="keyword">if</span> (dlLayout.isDrawerOpen(lvDrawerRight))&#123;</span><br><span class="line">                dlLayout.closeDrawer(lvDrawerRight)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 左侧菜单未打开</span></span><br><span class="line">                dlLayout.openDrawer(lvDrawerRight)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        initListDrawer()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化侧滑的菜单列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initListDrawer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">val</span> leftAdapter = ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>,R.layout.item_select,titleArr)</span><br><span class="line">        mBinding.lvDrawerLeft.adapter = leftAdapter</span><br><span class="line">        mBinding.lvDrawerLeft.setOnItemClickListener &#123; parent, view, position, id -&gt;</span><br><span class="line">            run &#123;</span><br><span class="line">                <span class="keyword">val</span> text = titleArr[position]</span><br><span class="line">                mBinding.tvDrawerCenter.text = <span class="string">"这里是<span class="subst">$&#123;text&#125;</span>页面"</span></span><br><span class="line">                <span class="comment">// 关闭所有抽屉</span></span><br><span class="line">                mBinding.dlLayout.closeDrawers()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 下面初始化右侧菜单的列表视图</span></span><br><span class="line">        <span class="keyword">val</span> rightAdapter = ArrayAdapter&lt;String&gt;(<span class="keyword">this</span>,R.layout.item_select,settingArray)</span><br><span class="line">        mBinding.lvDrawerRight.adapter = rightAdapter</span><br><span class="line">        mBinding.lvDrawerRight.setOnItemClickListener &#123; parent, view, position, id -&gt;</span><br><span class="line">            run &#123;</span><br><span class="line">                <span class="keyword">val</span> text = settingArray[position]</span><br><span class="line">                mBinding.tvDrawerCenter.text = <span class="string">"这里是<span class="subst">$&#123;text&#125;</span>页面"</span></span><br><span class="line">                <span class="comment">// 关闭所有抽屉</span></span><br><span class="line">                mBinding.dlLayout.closeDrawers()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个抽屉布局的侧滑监听器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">inner</span> <span class="class"><span class="keyword">class</span> <span class="title">SlidingListener</span>:<span class="type">DrawerLayout.DrawerListener&#123;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在拉出抽屉的过程中触发</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawerSlide</span><span class="params">(drawerView: <span class="type">View</span>, slideOffset: <span class="type">Float</span>)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在侧滑抽屉打开后触发</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawerOpened</span><span class="params">(drawerView: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (drawerView.id == R.id.lv_drawer_left)&#123;</span><br><span class="line">                mBinding.btnDrawerLeft.text = <span class="string">"关闭左边侧滑"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mBinding.btnDrawerRight.text = <span class="string">"关闭右边侧滑"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在侧滑抽屉关闭后触发</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawerClosed</span><span class="params">(drawerView: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (drawerView.id == R.id.lv_drawer_left)&#123;</span><br><span class="line">                mBinding.btnDrawerLeft.text = <span class="string">"打开左边侧滑"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mBinding.btnDrawerRight.text = <span class="string">"打开右边侧滑"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在侧滑状态变更时触发</span></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawerStateChanged</span><span class="params">(newState: <span class="type">Int</span>)</span></span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/13.png" alt></p>
<h3 id="3-正常下拉与下拉刷新的冲突处理"><a href="#3-正常下拉与下拉刷新的冲突处理" class="headerlink" title="3.正常下拉与下拉刷新的冲突处理"></a>3.正常下拉与下拉刷新的冲突处理</h3><p>​        自定义的下拉刷新布局首先要能够区分是页面的正常下滚还是拉到头部要求刷新。</p>
<p>​        二者之间的区别很简单，直观上就是判断当前页面是否拉到顶。倘若还没拉到顶，继续下拉动作属于正常的页面滚动；倘若已经拉到顶，继续下拉动作才会拉出头部提示刷新。所以此处需捕捉页面滚动到顶部的事件，相对应的是页面滚动到底部的事件。</p>
<p>​        鉴于App首页基本采用滚动视图实现页面滚动功能，故而该问题就变成如何监听该视图滚到顶部或者底部。ScrollView提供了滚动行为的变化方法onScrollChanged，通过重写该方法即可判断是否到达顶部或底部。重写后的代码片段如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>： LJH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Time</span>： 2022/9/9</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>：</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PullDownScrollView</span></span>(context:Context,attrs:AttributeSet):ScrollView(context, attrs) &#123;</span><br><span class="line">    <span class="comment">//横纵方向上的偏移</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mOffsetX = <span class="number">0f</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mOffsetY = <span class="number">0f</span></span><br><span class="line">    <span class="comment">//上次落点的横纵坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mLastPosX = <span class="number">0f</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mLastPosY = <span class="number">0f</span></span><br><span class="line">    <span class="comment">// 与边缘线的间距阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mInterval = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明一个滚动监听器对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mScrollListener:ScrollListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        mInterval = Utils.dip2px(context,<span class="number">3F</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">when</span>(ev?.action)&#123;</span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                mLastPosX = ev.x</span><br><span class="line">                mLastPosY = ev.y</span><br><span class="line">                result = <span class="keyword">super</span>.onInterceptTouchEvent(ev)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;<span class="comment">// 其余动作，包括手指移动、手指松开等等'</span></span><br><span class="line">                <span class="keyword">val</span> thisPosX = ev!!.x</span><br><span class="line">                <span class="keyword">val</span> thisPosY = ev.y</span><br><span class="line">                <span class="comment">//X轴偏差</span></span><br><span class="line">                mOffsetX += Math.abs(thisPosX - mLastPosX)</span><br><span class="line">                <span class="comment">//Y轴偏差</span></span><br><span class="line">                mOffsetY += Math.abs(thisPosY - mLastPosY)</span><br><span class="line">                mLastPosX = thisPosX</span><br><span class="line">                mLastPosY = thisPosY</span><br><span class="line">                <span class="keyword">if</span>(mOffsetX &lt; mInterval &amp;&amp; mOffsetY &lt; mInterval)&#123;</span><br><span class="line">                    <span class="comment">// false表示传给子控件，此时为点击事件</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOffsetX &lt; mOffsetY)&#123;</span><br><span class="line">                    <span class="comment">// true表示不传给子控件，此时为垂直滑动</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// false表示传给子控件，此时为水平滑动</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在滚动变更时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrollChanged</span><span class="params">(l: <span class="type">Int</span>, t: <span class="type">Int</span>, oldl: <span class="type">Int</span>, oldt: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onScrollChanged(l, t, oldl, oldt)</span><br><span class="line">        <span class="keyword">var</span> isScrolledToTop = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">var</span> isScrolledToBottom = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">when</span>&#123;</span><br><span class="line">            scrollY == <span class="number">0</span> -&gt; &#123;</span><br><span class="line">                isScrolledToTop = <span class="literal">true</span></span><br><span class="line">                isScrolledToBottom = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            (scrollY + height - paddingTop - paddingBottom) == getChildAt(<span class="number">0</span>).height -&gt; &#123;</span><br><span class="line">                isScrolledToBottom = <span class="literal">true</span></span><br><span class="line">                isScrolledToTop = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123;<span class="comment">// 未拉到顶部，也未拉到底部</span></span><br><span class="line">                isScrolledToTop = <span class="literal">false</span></span><br><span class="line">                isScrolledToTop = <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 定义一个滚动监听器接口，用于捕捉到达顶部和到达底部的事件</span></span><br><span class="line">        <span class="keyword">if</span> (mScrollListener != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (isScrolledToTop)&#123;<span class="comment">// 已经滚动到顶部</span></span><br><span class="line">                <span class="comment">// 触发下拉到顶部的事件</span></span><br><span class="line">                mScrollListener!!.onScrolledToTop()</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isScrolledToBottom)&#123; <span class="comment">// 已经滚动到底部</span></span><br><span class="line">                <span class="comment">// 触发上拉到底部的事件</span></span><br><span class="line">                mScrollListener!!.onScrolledToBottom()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个滚动监听器接口，用于捕捉到达顶部和到达底部的事件</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">ScrollListener</span></span>&#123;</span><br><span class="line">        <span class="comment">// 已经滚动到底部</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onScrolledToBottom</span><span class="params">()</span></span></span><br><span class="line">        <span class="comment">// 已经滚动到顶部</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">onScrolledToTop</span><span class="params">()</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置滚动监听器</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setScrollListener</span><span class="params">(listener:<span class="type">ScrollListener</span>)</span></span>&#123;</span><br><span class="line">        mScrollListener = listener</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        只要活动代码设置了滚动视图的滚动监听器，就能由onScrolledToTop方法判断当前页面是否拉到顶了。既然能够知晓到顶与否，同步变更状态栏和工具栏的背景色也就可行了。</p>
<p>​        考虑到下拉布局在上、滚动视图在下，故它俩的父布局继承线性布局比较合适。新的父视图需要完成以下3项任务：</p>
<ol>
<li>在子视图的最前面自动添加一个下拉刷新头部，保证该下拉头部位于整个页面的最上方。</li>
<li>给前面自定义的滚动视图注册滚动监听器和触摸监听器。其中，滚动监听器用于处理到达顶部和到达底部的事件，触摸监听器用于处理下拉过程中的持续位移。</li>
<li>重写触摸监听器接口需要实现的onTouch方法。这个是重中之重，因为该方法包含了所有的手势下拉跟踪处理，既要准确响应正常的下拉手势，也要避免误操作不属于下拉的手势，比如下面几种情况就要统筹考虑：<ul>
<li>水平方向的左右滑动，不做额外处理。</li>
<li>垂直方向的向上拉动，不做额外处理。</li>
<li>下拉的时候尚未拉到页面顶部，不做额外处理。</li>
<li>拉到顶之后继续下拉，则在隐藏工具栏的同时让下拉头部跟着往下滑动。</li>
<li>下拉刷新过程中松开手势，判断下拉滚动的距离，距离太短则直接缩回头部、不刷新页面，只有距离足够长才会刷新页面，等待刷新完毕再缩回头部。有了新定义的下拉上层布局，搭配自定义的滚动视图就能很方便地实现高仿京东首页的下拉刷新效果了。</li>
</ul>
</li>
</ol>
<p>布局：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:background</span>=<span class="string">"@color/white"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">tools:context</span>=<span class="string">".ui.PullRefreshActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">com.example.eventstudy.widget.PullDownRefreshLayout</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:id</span>=<span class="string">"@+id/pdrl_main"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">           <span class="tag">&lt;<span class="name">com.example.eventstudy.widget.PullDownScrollView</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:id</span>=<span class="string">"@+id/pdsv_main"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">               <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">com.example.eventstudy.widget.BannerPager</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:id</span>=<span class="string">"@+id/banner_pager"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_height</span>=<span class="string">"300dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:id</span>=<span class="string">"@+id/tv_flipper"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_height</span>=<span class="string">"300dp"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:background</span>=<span class="string">"#eeffee"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:gravity</span>=<span class="string">"top|center_horizontal"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:paddingTop</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:text</span>=<span class="string">"请反复下拉页面和上拉页面"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:textColor</span>=<span class="string">"@color/black"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:textSize</span>=<span class="string">"17sp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">View</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_height</span>=<span class="string">"1000dp"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:background</span>=<span class="string">"#9999ff"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">View</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:layout_height</span>=<span class="string">"10dp"</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:background</span>=<span class="string">"@color/white"</span> /&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">com.example.eventstudy.widget.PullDownScrollView</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;/<span class="name">com.example.eventstudy.widget.PullDownRefreshLayout</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- title_drag.xml是带搜索框的工具栏布局 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">android:id</span>=<span class="string">"@+id/drag_title"</span> <span class="attr">layout</span>=<span class="string">"@layout/title_drag"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自定义刷新布局：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PullDownRefreshLayout</span></span>(context:Context,attrs:AttributeSet):LinearLayout(context, attrs),View.OnTouchListener,PullDownScrollView.ScrollListener &#123;</span><br><span class="line">    <span class="comment">// 声明一个下拉滚动视图对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mScrollView:PullDownScrollView? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 下拉刷新头部的线性布局</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mLinearLayout:LinearLayout? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 下拉刷新头部的高度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mLayoutHeight = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 落点的位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mOriginPos: PointF? = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 当前的下拉高度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mCurrentHeight = <span class="number">0f</span></span><br><span class="line">    <span class="comment">// 触发工具栏变色的临界滑动距离</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mCriticalDistance =<span class="number">0</span></span><br><span class="line">    <span class="comment">// 声明一个下拉刷新的监听器对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mListener:PullRefreshListener? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">// 触发工具栏变色的临界滑动距离</span></span><br><span class="line">        mCriticalDistance = Utils.dip2px(context,<span class="number">20F</span>)</span><br><span class="line">        <span class="comment">// 获取默认的下拉刷新头部布局</span></span><br><span class="line">        mLinearLayout = LayoutInflater.from(context).inflate(R.layout.header_drag,<span class="literal">null</span>) <span class="keyword">as</span> LinearLayout</span><br><span class="line">        <span class="comment">// 计算下拉刷新头部布局的高度</span></span><br><span class="line">        mLayoutHeight = Utils.getRealHeight(mLinearLayout)</span><br><span class="line">        <span class="comment">// 间隔是负值，表示不但不远离，反而插了进去</span></span><br><span class="line">        mLinearLayout!!.setPadding(<span class="number">0</span>,-<span class="number">1</span> * mLayoutHeight,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">        <span class="comment">// 立刻刷新线性布局（线程安全方式）</span></span><br><span class="line">        mLinearLayout!!.postInvalidate()</span><br><span class="line">        <span class="comment">// 把下拉刷新头部布局添加到最前面</span></span><br><span class="line">        addView(mLinearLayout,<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 刷新完毕，恢复原页面，也就是仍把下拉头部缩了回去</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">finishRefresh</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 恢复主页面</span></span><br><span class="line">        resumePage()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">addView</span><span class="params">(child: <span class="type">View</span>?,index:<span class="type">Int</span>, params: <span class="type">ViewGroup</span>.<span class="type">LayoutParams</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// PullDownRefreshLayout下面要有个PullDownScrollView节点，不然会报错</span></span><br><span class="line">        <span class="keyword">if</span> (child!! <span class="keyword">is</span> PullDownScrollView)&#123;</span><br><span class="line">            mScrollView = child <span class="keyword">as</span> PullDownScrollView</span><br><span class="line">            <span class="comment">// 设置触摸监听器，目的是监控拉动的距离</span></span><br><span class="line">            mScrollView?.setOnTouchListener(<span class="keyword">this</span>)</span><br><span class="line">            <span class="comment">// 设置滚动监听器，目的是判断是否拉到顶部或者拉到底部</span></span><br><span class="line">            mScrollView?.setScrollListener(<span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.addView(child,index,params)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在拦截触摸事件时触发</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> action = ev?.action</span><br><span class="line">        <span class="comment">// 按下动作，记录下拉的起始位置</span></span><br><span class="line">        <span class="keyword">if</span> (action == MotionEvent.ACTION_DOWN)&#123;</span><br><span class="line">            mOriginPos = PointF(ev.rawX,ev.rawY)</span><br><span class="line">            mCurrentHeight = mScrollView!!.scrollY.toFloat()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(ev)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouch</span><span class="params">(v: <span class="type">View</span>?, event: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="comment">// 垂直方向的滚动距离小于临界距离，表示接近初始页面，需要把工具栏和状态栏恢复原样。</span></span><br><span class="line">        <span class="comment">// 否则表示页面正在上拉，需要给工具栏和状态栏变色。</span></span><br><span class="line">        <span class="keyword">if</span> (mScrollView!!.scrollY &lt;= mCriticalDistance)&#123;</span><br><span class="line">            mListener?.pullDown(mScrollView!!.scaleY*<span class="number">1.0</span> / mCriticalDistance)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mListener?.pullUp(mScrollView!!.scaleY * <span class="number">1.0</span> / mCriticalDistance)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> action = event?.action</span><br><span class="line">        <span class="comment">// 按下0，松开1，滑动2</span></span><br><span class="line">        <span class="keyword">when</span> &#123;</span><br><span class="line">            event!!.rawY &lt;= mOriginPos!!.y -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            mScrollView!!.scrollY &gt; <span class="number">0</span> -&gt; &#123; <span class="comment">// 未拉到顶部，不处理</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            mScrollView!!.scrollY &lt;= <span class="number">0</span> -&gt; &#123; <span class="comment">// 正在下拉，则隐藏工具栏</span></span><br><span class="line">                mListener!!.hideTitle()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 计算下拉过程的拉动距离</span></span><br><span class="line">        <span class="keyword">val</span> offsetY = event!!.rawY - mOriginPos!!.y - mCurrentHeight</span><br><span class="line">        <span class="keyword">when</span>(action)&#123;</span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123; <span class="comment">// 按下手指</span></span><br><span class="line">                mOriginPos?.y = event.rawY</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123; <span class="comment">// 移动手指</span></span><br><span class="line">                <span class="comment">// 下拉刷新的实际距离减半，看起来不会太突兀</span></span><br><span class="line">                <span class="keyword">val</span> dragOffset:<span class="built_in">Int</span> = ((-<span class="number">1</span> * mLayoutHeight) + offsetY/<span class="number">2</span>).toInt()</span><br><span class="line">                <span class="comment">// 下拉刷新的头部布局露出庐山真面目啦</span></span><br><span class="line">                mLinearLayout?.setPadding(<span class="number">0</span>, dragOffset,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">                <span class="comment">// 立刻刷新线性布局（线程安全方式）</span></span><br><span class="line">                mLinearLayout?.postInvalidate()</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123; <span class="comment">// 松开手指</span></span><br><span class="line">                <span class="comment">// 下拉距离太短，则直接将页面恢复原状。只有下拉距离足够长，才会触发页面刷新动作</span></span><br><span class="line">                <span class="keyword">if</span> (offsetY &lt;= Utils.dip2px(context,<span class="number">150F</span>))&#123;</span><br><span class="line">                    resumePage()</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mListener!!.pullRefresh()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumePage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//设置线性布局上方的空白距离</span></span><br><span class="line">        mLinearLayout?.apply &#123;</span><br><span class="line">            setPadding(<span class="number">0</span>,(-<span class="number">1</span> * mLayoutHeight),<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">            <span class="comment">// 立刻刷新线性布局（线程安全方式）</span></span><br><span class="line">            postInvalidate()</span><br><span class="line">            mListener?.showTitle()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrolledToBottom</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrolledToTop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mListener?.pullDown(<span class="number">0.0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个下拉刷新的监听器接口</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">PullRefreshListener</span></span>&#123;</span><br><span class="line">        <span class="comment">// 正在上拉</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">pullUp</span><span class="params">(scale:<span class="type">Double</span>)</span></span></span><br><span class="line">        <span class="comment">// 正在下拉</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">pullDown</span><span class="params">(scale:<span class="type">Double</span>)</span></span></span><br><span class="line">        <span class="comment">// 开始刷新动作</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">pullRefresh</span><span class="params">()</span></span></span><br><span class="line">        <span class="comment">//隐藏标题栏</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">hideTitle</span><span class="params">()</span></span></span><br><span class="line">        <span class="comment">//显示标题栏</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">showTitle</span><span class="params">()</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setPullRefreshListener</span><span class="params">(listener: <span class="type">PullRefreshListener</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mListener = listener</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>activity:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PullRefreshActivity</span> : <span class="type">BaseActivity</span>&lt;<span class="type">ActivityPullRefreshBinding</span>&gt;</span>(),PullDownRefreshLayout.PullRefreshListener &#123;</span><br><span class="line">    <span class="comment">// 是否正在拖动</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isDragging = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// 声明一个进度对话框对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mDialog:ProgressDialog? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> ActivityPullRefreshBinding.<span class="title">initBinding</span><span class="params">()</span></span> &#123;</span><br><span class="line">        bannerPager.setImage(ImageList.getDefault())</span><br><span class="line">        <span class="comment">// 设置下拉刷新监听器</span></span><br><span class="line">        pdrlMain.setPullRefreshListener(<span class="keyword">this</span><span class="symbol">@PullRefreshActivity</span>)</span><br><span class="line">        <span class="comment">// 设置广告轮播条的图片点击监听器</span></span><br><span class="line">        bannerPager.setOnBannerListener(<span class="keyword">object</span> :BannerPager.BannerClickListener&#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBannerClick</span><span class="params">(position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">                tvFlipper.text = <span class="string">"您点击了第<span class="subst">$&#123;position+<span class="number">1</span>&#125;</span>张图片"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 添加悬浮状态栏效果</span></span><br><span class="line">        floatStatusBar()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">floatStatusBar</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 让App页面扩展到状态栏区域</span></span><br><span class="line">        StatusBarUtil.fullScreen(<span class="keyword">this</span>)</span><br><span class="line">        <span class="comment">// 标题栏在上方留出一段距离，看起来仍在状态栏下方</span></span><br><span class="line">        <span class="keyword">val</span> titleParams = mBinding.dragTitle.llTitle.layoutParams <span class="keyword">as</span> RelativeLayout.LayoutParams</span><br><span class="line">        <span class="comment">// 标题栏在上方留出一段距离，看起来仍在状态栏下方</span></span><br><span class="line">        titleParams.topMargin = StatusBarUtil.getStatusBarHeight(<span class="keyword">this</span>)</span><br><span class="line">        mBinding.dragTitle.llTitle.layoutParams = titleParams</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始页面刷新</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">beginRefresh</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mDialog == <span class="literal">null</span> || !mDialog!!.isShowing)&#123;</span><br><span class="line">            <span class="comment">// 显示进度对话框</span></span><br><span class="line">            mDialog = ProgressDialog.show(<span class="keyword">this</span>,<span class="string">"请稍等"</span>,<span class="string">"正在努力刷新页面"</span>)</span><br><span class="line">            <span class="comment">// 延迟1秒后启动刷新结束任务</span></span><br><span class="line">            Handler(Looper.myLooper()!!).postDelayed(&#123;endRefresh()&#125;,<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结束页面刷新</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">endRefresh</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isDragging)&#123;</span><br><span class="line">            <span class="comment">// 关闭进度对话框</span></span><br><span class="line">            mDialog?.dismiss()</span><br><span class="line">            mBinding.pdrlMain.finishRefresh()</span><br><span class="line">            isDragging = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算标题栏与状态栏的渐变背景色</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTitleBgColor</span><span class="params">(scale:<span class="type">Double</span>)</span></span>:<span class="built_in">Int</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> alpha = Math.round(scale / <span class="number">2</span> * <span class="number">255</span>)</span><br><span class="line">        alpha = Math.min(alpha,<span class="number">255</span>)</span><br><span class="line">        <span class="keyword">return</span> Color.parseColor(<span class="string">"#00000000"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">pullUp</span><span class="params">(scale: <span class="type">Double</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> bgColor = getTitleBgColor(scale)</span><br><span class="line">        mBinding.dragTitle.llTitle.setBackgroundColor(bgColor)</span><br><span class="line">        mBinding.dragTitle.llTitle.visibility = View.VISIBLE</span><br><span class="line">        mBinding.dragTitle.ivScan.setImageResource(R.drawable.icon_scan_gray)</span><br><span class="line">        mBinding.dragTitle.ivMsg.setImageResource(R.drawable.icon_msg_gray)</span><br><span class="line">        <span class="comment">// 上拉页面，让状态栏背景渐渐变为白色</span></span><br><span class="line">        StatusBarUtil.setStatusBarColor(<span class="keyword">this</span>,bgColor,<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">pullDown</span><span class="params">(scale: <span class="type">Double</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> bgColor = getTitleBgColor(scale)</span><br><span class="line">        mBinding.dragTitle.llTitle.setBackgroundColor(bgColor)</span><br><span class="line">        mBinding.dragTitle.llTitle.visibility = View.VISIBLE</span><br><span class="line">        mBinding.dragTitle.ivScan.setImageResource(R.drawable.icon_scan_white)</span><br><span class="line">        mBinding.dragTitle.ivMsg.setImageResource(R.drawable.icon_msg_white)</span><br><span class="line">        <span class="comment">// 下拉到顶了，让状态栏背景渐渐变为透明</span></span><br><span class="line">        StatusBarUtil.setStatusBarColor(<span class="keyword">this</span>,bgColor,<span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">pullRefresh</span><span class="params">()</span></span> &#123;</span><br><span class="line">        isDragging = <span class="literal">true</span></span><br><span class="line">        beginRefresh()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">hideTitle</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mBinding.dragTitle.llTitle.visibility = View.INVISIBLE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">showTitle</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mBinding.dragTitle.llTitle.visibility = View.INVISIBLE</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/05/%E4%BA%8B%E4%BB%B6%E4%BA%A4%E4%BA%92/14.png" alt></p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://gitee.com/hluck/android-event-interaction.git" target="_blank" rel="noopener">https://gitee.com/hluck/android-event-interaction.git</a></p>
<h2 id="实战项目：仿美图秀秀的抠图工具"><a href="#实战项目：仿美图秀秀的抠图工具" class="headerlink" title="实战项目：仿美图秀秀的抠图工具"></a>实战项目：仿美图秀秀的抠图工具</h2>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/24/WanAndriod%E9%A1%B9%E7%9B%AE%E8%AE%B0%E5%BD%95/" rel="prev" title="WanAndriod项目记录">
      <i class="fa fa-chevron-left"></i> WanAndriod项目记录
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/17/GreenDao/" rel="next" title="GreenDao">
      GreenDao <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#按键事件"><span class="nav-number">1.</span> <span class="nav-text">按键事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-检测软键盘"><span class="nav-number">1.1.</span> <span class="nav-text">1.检测软键盘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-检测物理按键"><span class="nav-number">1.2.</span> <span class="nav-text">2.检测物理按键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-接管返回按键"><span class="nav-number">1.3.</span> <span class="nav-text">3.接管返回按键</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#触摸事件"><span class="nav-number">2.</span> <span class="nav-text">触摸事件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-手势事件的分发流程"><span class="nav-number">2.1.</span> <span class="nav-text">1.手势事件的分发流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-接管手势事件处理"><span class="nav-number">2.2.</span> <span class="nav-text">2.接管手势事件处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-跟踪滑动轨迹实现手写签名"><span class="nav-number">2.3.</span> <span class="nav-text">3.跟踪滑动轨迹实现手写签名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#根据触摸行为辨别手势动作"><span class="nav-number">3.</span> <span class="nav-text">根据触摸行为辨别手势动作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-区分点击和长按动作"><span class="nav-number">3.1.</span> <span class="nav-text">1.区分点击和长按动作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-识别手势滑动的方向"><span class="nav-number">3.2.</span> <span class="nav-text">2.识别手势滑动的方向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-辨别缩放与旋转手势"><span class="nav-number">3.3.</span> <span class="nav-text">3.辨别缩放与旋转手势</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#手势冲突处理"><span class="nav-number">4.</span> <span class="nav-text">手势冲突处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-上下滚动与左右滑动的冲突处理"><span class="nav-number">4.1.</span> <span class="nav-text">1.上下滚动与左右滑动的冲突处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-内部滑动与翻页滑动的冲突处理"><span class="nav-number">4.2.</span> <span class="nav-text">2.内部滑动与翻页滑动的冲突处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-正常下拉与下拉刷新的冲突处理"><span class="nav-number">4.3.</span> <span class="nav-text">3.正常下拉与下拉刷新的冲突处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码地址"><span class="nav-number">5.</span> <span class="nav-text">源码地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战项目：仿美图秀秀的抠图工具"><span class="nav-number">6.</span> <span class="nav-text">实战项目：仿美图秀秀的抠图工具</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="余一"
      src="/images/avatar5.jpg">
  <p class="site-author-name" itemprop="name">余一</p>
  <div class="site-description" itemprop="description">纸上得来终觉浅，绝知此事要躬行。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">172</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.bilibili.com/" title="https:&#x2F;&#x2F;www.bilibili.com&#x2F;" rel="noopener" target="_blank">Bilibili</a>
        </li>
    </ul>
  </div>

	
           
         
         <div style="">
  <canvas id="canvas" style="width:60%;">��ǰ�������֧��canvas������������������</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //����canvas�Ŀ���
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //�洢ʱ������
    var data = [];
    //�洢�˶���С��
    var balls = [];
    //�������Ӱ뾶
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //�洢ʱ�����֣���ʮλСʱ����λСʱ��ð�š�ʮλ���ӡ���λ���ӡ�ð�š�ʮλ���ӡ���λ������7���������
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*���ɵ�������*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*����ʱ��*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //ʱ�䷢���仯
            if(NewData[i] !== data[i]){
                //���仯������ֵ����data�����е������洢��changeNumArray������
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //����С��
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*����С��״̬*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*����Ҫ�˶���С��*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*��Ⱦ*/
    function render(){
        //���û������ȣ��ﵽ��ջ�����Ч��
        canvas.height = 100;
        //��Ⱦʱ��
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //��ȾС��
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //����ʱ��
        updateDigitTime();
        //����С��״̬
        updateBalls();
        //��Ⱦ
        render();
    },50);
}

})();
</script>
      </div>
	
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">余一</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:38</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

  <script async src="/js/cursor/fireworks.js"></script>

</body>
</html>
